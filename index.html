<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Melodic Feed</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Billabong&display=swap');

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  background-color: #121212;
  color: #eee;
  margin:0; padding:0;
  user-select:none;
}

header {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 20px;
  background-color:#1e1e1e;
  border-bottom:1px solid #333;
  position:sticky; top:0; z-index:1000;
}

header h1 {
  font-family:'Billabong',cursive; font-size:28px; margin:0;
  color:#fff;
}

.menu-container { position:relative; }
.menu-icon { cursor:pointer; font-size:22px; color:#fff; }
.dropdown {
  display:none; position:absolute; top:40px; right:0;
  background:#1e1e1e; border:1px solid #333; border-radius:6px; padding:10px;
}
.dropdown select, .dropdown input {
  width:150px; margin-bottom:8px; padding:5px; background:#222; color:#eee; border:1px solid #555; border-radius:4px;
}

.feed { max-width:600px; margin:20px auto; padding:0; }
.post {
  background:#1e1e1e; border-radius:8px; padding:15px; margin-bottom:15px;
  border:1px solid #333; box-shadow:0 0 1px rgba(0,0,0,0.5);
  user-select:none;
}
.post-header { display:flex; align-items:center; margin-bottom:10px; }
.avatar { width:40px; height:40px; border-radius:50%; background:#3a3a3a; color:#fff; display:flex; align-items:center; justify-content:center; margin-right:10px; }
.post-actions { display:flex; gap:10px; margin-top:10px; padding-top:10px; border-top:1px solid #444; }
.action-btn { flex:1; padding:8px; border:none; background:none; cursor:pointer; color:#b3b3b3; font-weight:bold; text-align:center; }
.action-btn:hover { background:#333; border-radius:4px; }
.action-btn.liked { color:#ed4956; }

video, img { max-width:100%; border-radius:8px; }
</style>
</head>
<body>
<header>
<h1>Melofeed</h1>
<div class="menu-container">
<span class="menu-icon">☰</span>
<div class="dropdown">
<select id="instrumentSelect">
<option value="Synth">Synth</option>
<option value="AMSynth">AMSynth</option>
<option value="FMSynth">FMSynth</option>
<option value="DuoSynth">DuoSynth</option>
</select>
<select id="effectSelect">
<option value="none">No Effect</option>
<option value="reverb">Reverb</option>
<option value="chorus">Chorus</option>
<option value="distortion">Distortion</option>
<option value="tremolo">Tremolo</option>
<option value="vibrato">Vibrato</option>
<option value="delay">Delay</option>
</select>
<select id="scaleSelect">
<option value="major">Major</option>
<option value="minor">Minor</option>
<option value="dorian">Dorian</option>
<option value="phrygian">Phrygian</option>
<option value="lydian">Lydian</option>
<option value="mixolydian">Mixolydian</option>
<option value="locrian">Locrian</option>
<option value="harmonicMinor">Harmonic Minor</option>
<option value="pentatonicMajor">Pentatonic Major</option>
<option value="pentatonicMinor">Pentatonic Minor</option>
</select>
<select id="tonalitySelect">
<option value="C">C</option>
<option value="C#">C#</option>
<option value="D">D</option>
<option value="D#">D#</option>
<option value="E">E</option>
<option value="F">F</option>
<option value="F#">F#</option>
<option value="G">G</option>
<option value="G#">G#</option>
<option value="A">A</option>
<option value="A#">A#</option>
<option value="B">B</option>
</select>
<input type="number" id="arpeggioBPM" placeholder="BPM" value="120" style="width:60px;">
<select id="arpeggioType">
<option value="up">Ascendente</option>
<option value="down">Descendente</option>
<option value="random">Random</option>
</select>
</div>
</div>
</header>

<div class="feed" role="feed" aria-live="polite">
<div id="posts-container"></div>
<div id="sentinel"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
<script src="media-list.js"></script>
<script>
// --- Variables ---
let synth=null, effectNode=null;
let currentScale="major", currentTonality="C";
const scales={
major:[0,2,4,5,7,9,11],
minor:[0,2,3,5,7,8,10],
dorian:[0,2,3,5,7,9,10],
phrygian:[0,1,3,5,7,8,10],
lydian:[0,2,4,6,7,9,11],
mixolydian:[0,2,4,5,7,9,10],
locrian:[0,1,3,5,6,8,10],
harmonicMinor:[0,2,3,5,7,8,11],
pentatonicMajor:[0,2,4,7,9],
pentatonicMinor:[0,3,5,7,10]
};
const tonalities=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
let postId=0, isLoading=false;
let activeTouches={};
let arpeggioNotes=[], arpeggioIndex=0, arpeggioInterval=null;

// --- Tone.js ---
function createSynth(type="Synth"){ if(synth) synth.dispose(); synth=new Tone[type]().toDestination(); }
function applyEffect(type){
  if(effectNode){ effectNode.dispose(); synth.connect(Tone.Destination); }
  if(type!=="none"){switch(type){
    case "reverb": effectNode=new Tone.Reverb().toDestination(); break;
    case "chorus": effectNode=new Tone.Chorus().toDestination(); break;
    case "distortion": effectNode=new Tone.Distortion(0.4).toDestination(); break;
    case "tremolo": effectNode=new Tone.Tremolo().start().toDestination(); break;
    case "vibrato": effectNode=new Tone.Vibrato().toDestination(); break;
    case "delay": effectNode=new Tone.FeedbackDelay("8n",0.5).toDestination(); break;
  } synth.connect(effectNode);}
}
document.getElementById("instrumentSelect").addEventListener("change", e=>{createSynth(e.target.value); applyEffect(document.getElementById("effectSelect").value);});
document.getElementById("effectSelect").addEventListener("change", e=>applyEffect(e.target.value));
document.getElementById("scaleSelect").addEventListener("change", e=>currentScale=e.target.value);
document.getElementById("tonalitySelect").addEventListener("change", e=>currentTonality=e.target.value);

// --- Posts ---
function renderMedia(filePath){
  const ext=filePath.split(".").pop().toLowerCase();
  if(["jpg","jpeg","png"].includes(ext)) return `<img src="${filePath}" style="width:100%; border-radius:8px;">`;
  if(ext==="mp4") return `<video src="${filePath}" style="width:100%; border-radius:8px;" muted preload="metadata"></video>`;
  return "";
}
function generatePost(){
  if(!mediaList || mediaList.length===0) return null;
  let tries=0, media=null;
  while(tries<10){ media=mediaList[Math.floor(Math.random()*mediaList.length)]; if(media) break; tries++; }
  if(!media) return null;
  return {id:postId++, name:"User", text:"Random post", media:media};
}
function createPost(postData){
  if(!postData) return null;
  const div=document.createElement("div"); div.className="post";
  div.innerHTML=`<div class="post-header"><div class="avatar">${postData.name[0]}</div><div><strong>${postData.name}</strong></div></div>
  <div>${postData.text}</div>${postData.media?renderMedia(postData.media):""}<div class="post-actions"><button class="action-btn like-btn">❤️</button></div>`;
  const video=div.querySelector("video");
  if(video){ video.pause(); video.volume=0.2; video.addEventListener("click",()=>video.paused?video.play():video.pause()); }
  return div;
}
function loadMore(){ if(isLoading) return; isLoading=true;
  const container=document.getElementById("posts-container");
  for(let i=0;i<3;i++){ const postData=generatePost(); const post=createPost(postData); if(post) container.appendChild(post);}
  isLoading=false;
}
const sentinel=document.getElementById("sentinel");
const observer=new IntersectionObserver(entries=>{if(entries[0].isIntersecting) loadMore();},{rootMargin:"200px 0px"});
observer.observe(sentinel);

// --- Arpeggiator ---
function stopArpeggio(){ if(arpeggioInterval){clearInterval(arpeggioInterval); arpeggioInterval=null; activeTouches={}; } }
function startArpeggio(rootNoteY){
  stopArpeggio();
  const rootNote=getNoteFromY(rootNoteY);
  const scaleIntervals=scales[currentScale];
  arpeggioNotes=[];
  const rootIndex=tonalities.indexOf(rootNote.replace(/[0-9]/g,""));
  const rootOctave=parseInt(rootNote[rootNote.length-1]);
  for(let i=0;i<8;i++){
    const step=(i*2)%scaleIntervals.length;
    const semitone=(scaleIntervals[step]+rootIndex)%12;
    const octave=rootOctave+Math.floor((i*2)/scaleIntervals.length);
    arpeggioNotes.push(tonalities[semitone]+octave);
  }
  const bpm=parseInt(document.getElementById("arpeggioBPM").value)||120;
  const intervalMs=60000/bpm;
  let idx=0;
  arpeggioInterval=setInterval(()=>{
    synth.triggerAttackRelease(arpeggioNotes[idx],"8n");
    idx=(idx+1)%arpeggioNotes.length;
  }, intervalMs);
}

// --- Touch ---
function getNoteFromY(y){
  const pos=1-(y/window.innerHeight);
  const scale=scales[currentScale]; const tonalityIndex=tonalities.indexOf(currentTonality);
  const totalNotes=scale.length*2;
  const noteIndex=Math.floor(pos*totalNotes);
  const octave=3+Math.floor(noteIndex/scale.length);
  const semitone=(scale[noteIndex%scale.length]+tonalityIndex)%12;
  return tonalities[semitone]+octave;
}
window.addEventListener("touchstart", e=>{
  Tone.start();
  if(e.touches.length===1) playSingle(e.touches[0].clientY);
  if(e.touches.length===2) startArpeggio(e.touches[0].clientY);
});
function playSingle(y){ stopArpeggio(); const note=getNoteFromY(y); synth.triggerAttack(note); activeTouches["touch"]=note; }
window.addEventListener("touchend", e=>{ stopArpeggio(); for(let t of e.changedTouches) if(activeTouches["touch"]) synth.triggerRelease(activeTouches["touch"]); activeTouches={};});

// --- Menu toggle ---
document.querySelector(".menu-icon").addEventListener("click",()=>{const d=document.querySelector(".dropdown"); d.style.display=d.style.display==="block"?"none":"block";});

// --- Init ---
createSynth(); applyEffect("none"); loadMore();
</script>
</body>
</html>
