<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Melodic Feed</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Billabong&display=swap');

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #121212;
      color: #eee;
      margin: 0;
      padding: 0;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background-color: #1e1e1e;
      border-bottom: 1px solid #333;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    header h1 {
      font-family: 'Billabong', cursive;
      font-size: 28px;
      margin: 0;
      color: #fff;
    }

    .menu-container {
      position: relative;
    }

    .menu-icon {
      cursor: pointer;
      font-size: 22px;
      color: #fff;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 40px;
      right: 0;
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px;
      z-index: 1001;
    }

    .dropdown select {
      width: 150px;
      margin-bottom: 8px;
      padding: 5px;
      background: #222;
      color: #eee;
      border: 1px solid #555;
      border-radius: 4px;
    }

    .feed {
      max-width: 600px;
      margin: 20px auto;
      padding: 0;
    }

    .post {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      border: 1px solid #333;
    }

    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #3a3a3a;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }

    .actions {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
    }

    .actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: #eee;
      font-size: 18px;
    }

    .actions button:hover {
      color: #ff4081;
    }

    .skeleton-post {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      height: 150px;
      animation: pulse 1.5s infinite;
      border: 1px solid #333;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Melofeed</h1>
    <div class="menu-container">
      <span class="menu-icon">‚ò∞</span>
      <div class="dropdown">
        <select id="instrumentSelect">
          <option value="Synth">Synth</option>
          <option value="AMSynth">AMSynth</option>
          <option value="FMSynth">FMSynth</option>
          <option value="DuoSynth">DuoSynth</option>
        </select>
        <select id="effectSelect">
          <option value="none">No Effect</option>
          <option value="reverb">Reverb</option>
          <option value="chorus">Chorus</option>
          <option value="distortion">Distortion</option>
          <option value="tremolo">Tremolo</option>
          <option value="vibrato">Vibrato</option>
          <option value="delay">Delay</option>
        </select>
        <select id="scaleSelect">
          <option value="major">Major</option>
          <option value="minor">Minor</option>
          <option value="dorian">Dorian</option>
          <option value="phrygian">Phrygian</option>
          <option value="lydian">Lydian</option>
          <option value="mixolydian">Mixolydian</option>
          <option value="locrian">Locrian</option>
          <option value="harmonicMinor">Harmonic Minor</option>
          <option value="pentatonicMajor">Pentatonic Major</option>
          <option value="pentatonicMinor">Pentatonic Minor</option>
        </select>
        <select id="tonalitySelect">
          <option value="C">C</option>
          <option value="C#">C#</option>
          <option value="D">D</option>
          <option value="D#">D#</option>
          <option value="E">E</option>
          <option value="F">F</option>
          <option value="F#">F#</option>
          <option value="G">G</option>
          <option value="G#">G#</option>
          <option value="A">A</option>
          <option value="A#">A#</option>
          <option value="B">B</option>
        </select>
      </div>
    </div>
  </header>

  <main class="feed" id="feed">
    <div id="posts-container"></div>
    <div id="sentinel"></div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
  <script src="media-list.js"></script>

  <script>
    let postId = 0;
    let isLoading = false;
    const feed = document.getElementById("posts-container");

    // ------------------- Tone.js -------------------
    let synth, lowPass, effectNode;
    lowPass = new Tone.Filter(20000, "lowpass").toDestination();

    function createSynth(type="Synth") {
      if(synth) synth.dispose();
      synth = new Tone[type]().connect(lowPass);
    }

    function applyEffect(type) {
      if(effectNode){ effectNode.dispose(); synth.disconnect(); synth.connect(lowPass); }
      if(type !== "none"){
        switch(type){
          case "reverb": effectNode = new Tone.Reverb().toDestination(); break;
          case "chorus": effectNode = new Tone.Chorus().toDestination(); break;
          case "distortion": effectNode = new Tone.Distortion(0.4).toDestination(); break;
          case "tremolo": effectNode = new Tone.Tremolo().start().toDestination(); break;
          case "vibrato": effectNode = new Tone.Vibrato().toDestination(); break;
          case "delay": effectNode = new Tone.FeedbackDelay("8n",0.5).toDestination(); break;
        }
        synth.disconnect();
        synth.connect(effectNode);
      }
    }

    createSynth("Synth");

    document.getElementById("instrumentSelect").addEventListener("change", e => { createSynth(e.target.value); applyEffect(document.getElementById("effectSelect").value); });
    document.getElementById("effectSelect").addEventListener("change", e => applyEffect(e.target.value));

    const scales = {
      major:[0,2,4,5,7,9,11],
      minor:[0,2,3,5,7,8,10],
      dorian:[0,2,3,5,7,9,10],
      phrygian:[0,1,3,5,7,8,10],
      lydian:[0,2,4,6,7,9,11],
      mixolydian:[0,2,4,5,7,9,10],
      locrian:[0,1,3,5,6,8,10],
      harmonicMinor:[0,2,3,5,7,8,11],
      pentatonicMajor:[0,2,4,7,9],
      pentatonicMinor:[0,3,5,7,10]
    };
    const tonalities = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    let currentScale = "major";
    let currentTonality = "C";
    document.getElementById("scaleSelect").addEventListener("change", e => currentScale = e.target.value);
    document.getElementById("tonalitySelect").addEventListener("change", e => currentTonality = e.target.value);

    function getNoteFromY(y){
      const height = window.innerHeight;
      const position = 1 - (y / height);
      const scale = scales[currentScale];
      const tonalityIndex = tonalities.indexOf(currentTonality);
      const totalNotes = scale.length * 2;
      const noteIndex = Math.floor(position * totalNotes);
      const octave = 3 + Math.floor(noteIndex / scale.length);
      const semitone = (scale[noteIndex % scale.length] + tonalityIndex) % 12;
      return tonalities[semitone]+octave;
    }

    // Input touch/mouse
    let active = false;
    function startSound(y,x){ const note = getNoteFromY(y); synth.triggerAttack(note); updateFilter(x); }
    function updateSound(y,x){ if(!active) return; const note = getNoteFromY(y); synth.setNote(note); updateFilter(x); }
    function stopSound(){ synth.triggerRelease(); }
    function updateFilter(x){ const freq = Tone.Frequency(200 + (x/window.innerWidth)*8000); lowPass.frequency.setValueAtTime(freq,Tone.now()); }
    window.addEventListener("touchstart", e => { if(e.target.closest("header")) return; active=true; Tone.start(); const t=e.touches[0]; startSound(t.clientY,t.clientX); });
    window.addEventListener("touchmove", e => { if(active){ const t=e.touches[0]; updateSound(t.clientY,t.clientX); } });
    window.addEventListener("touchend", ()=>{ active=false; stopSound(); });
    window.addEventListener("mousedown", e => { if(e.target.closest("header")) return; active=true; Tone.start(); startSound(e.clientY,e.clientX); });
    window.addEventListener("mousemove", e => { if(active){ updateSound(e.clientY,e.clientX); } });
    window.addEventListener("mouseup", ()=>{ active=false; stopSound(); });

    // ------------------- Post generation -------------------
    function renderMedia(filePath){
      const ext = filePath.split('.').pop().toLowerCase();
      if(!filePath) return "";
      if(["jpg","jpeg","png"].includes(ext)){
        return `<div style="margin-top:10px;"><img src="${filePath}" alt="Post media" style="width:100%; border-radius:8px;"></div>`;
      }else if(ext==="mp4"){
        return `<div style="margin-top:10px;"><video src="${filePath}" controls style="width:100%; border-radius:8px;"></video></div>`;
      }else return "";
    }

    function generatePost(){
      if(typeof mediaList==="undefined" || mediaList.length===0) return null;
      let postData=null;
      let attempts=0;
      while(!postData && attempts<5){
        const media = mediaList[Math.floor(Math.random()*mediaList.length)];
        // Check if file exists
        const xhr = new XMLHttpRequest();
        xhr.open('HEAD', media, false);
        try{
          xhr.send();
          if(xhr.status>=200 && xhr.status<400){
            postData = { id: postId++, name:"User", text:"Post", media };
          }
        }catch(e){ }
        attempts++;
      }
      return postData;
    }

    function createPostElement(postData){
      const div = document.createElement('div');
      div.className='post';
      div.dataset.postId=postData.id;
      div.innerHTML=`
        <div class="post-header">
          <div class="avatar">${postData.name[0]}</div>
          <div>
            <div><strong>${postData.name}</strong></div>
            <div style="font-size: 12px; color: #999;">2 hours ago</div>
          </div>
        </div>
        <div>${postData.text}</div>
        ${renderMedia(postData.media)}
        <div class="actions">
          <button>‚ù§Ô∏è</button>
          <button>üí¨</button>
          <button>üîó</button>
        </div>
      `;
      return div;
    }

    function loadMorePosts(){
      if(isLoading) return;
      isLoading=true;
      const skeletons=[];
      for(let i=0;i<5;i++){
        const sk=document.createElement('div');
        sk.className='skeleton-post';
        feed.appendChild(sk);
        skeletons.push(sk);
      }
      setTimeout(()=>{
        skeletons.forEach(sk=>{
          const postData = generatePost();
          if(postData){
            const postEl = createPostElement(postData);
            sk.replaceWith(postEl);
          }else sk.remove();
        });
        isLoading=false;
      }, 800);
    }

    const sentinel = document.getElementById('sentinel');
    const observer = new IntersectionObserver(entries=>{
      if(entries[0].isIntersecting) loadMorePosts();
    }, { rootMargin: '200px 0px' });
    observer.observe(sentinel);

    window.addEventListener('DOMContentLoaded', ()=>{ loadMorePosts(); setTimeout(()=>loadMorePosts(),100); });

    // Menu toggle
    const menuIcon = document.querySelector(".menu-icon");
    const dropdown = document.querySelector(".dropdown");
    menuIcon.addEventListener("click", () => {
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    });
  </script>
</body>
</html>
