<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Melodic Feed</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Billabong&display=swap');
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin:0; background:#121212; color:#e0e0e0; }
.header { background:#1f1f1f; padding:15px 20px; box-shadow:0 1px 3px rgba(0,0,0,0.7); position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:center; border-bottom:1px solid #333; }
.header h1 { font-family:'Billabong', cursive; font-size:32px; color:#e0e0e0; }
.feed { max-width:600px; margin:20px auto; padding:0; }
.post { background:#1e1e1e; border-radius:8px; padding:15px; margin-bottom:15px; box-shadow:0 0 1px rgba(0,0,0,0.5); border:1px solid #333; }
.post-header { display:flex; align-items:center; margin-bottom:10px; }
.avatar { width:40px; height:40px; border-radius:50%; background:#3a3a3a; color:#fff; display:flex; align-items:center; justify-content:center; margin-right:10px; }
.post-actions { display:flex; gap:10px; margin-top:10px; padding-top:10px; border-top:1px solid #444; }
.action-btn { flex:1; padding:8px; border:none; background:none; cursor:pointer; color:#b3b3b3; font-weight:bold; text-align:center; }
.action-btn:hover { background:#333; border-radius:4px; }
.action-btn.liked { color:#ed4956; }
.skeleton-post { background:#1e1e1e; border-radius:8px; padding:15px; margin-bottom:15px; height:150px; animation:pulse 1.5s infinite; border:1px solid #333; }
@keyframes pulse { 0%{opacity:0.6} 50%{opacity:1} 100%{opacity:0.6} }
</style>
</head>
<body>
<div class="header"><h1>üéµ MeloFeed</h1></div>
<div class="feed" role="feed" aria-live="polite">
    <div id="posts-container"></div>
    <div id="sentinel"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tone@next/build/Tone.js"></script>
<script src="media-list.js"></script>
<script>
let postId = 0, isLoading = false, currentWaveform = 'sine';
const voices = {}; // pointerId -> Tone.Synth

// minor pentatonic C scale across octaves
const basePitches = ['C4','D#4','F4','G4','A#4','C5','D#5','F5','G5','A#5'];

function yToNote(y){
    const norm = 1 - Math.min(Math.max(y/window.innerHeight,0),1);
    const idx = Math.floor(norm * (basePitches.length-1));
    return basePitches[idx];
}
function xToFilter(x){
    const norm = Math.min(Math.max(x/window.innerWidth,0),1);
    return 200 + norm*(8000-200);
}

function startVoice(id,x,y){
    if(Object.keys(voices).length >= 3) return;
    if(voices[id]) return;
    const synth = new Tone.Synth({ oscillator: { type: currentWaveform }, envelope: { attack:0.01, decay:0.1, sustain:0.5, release:0.2 } }).toDestination();
    const filter = new Tone.Filter(xToFilter(x), "lowpass").toDestination();
    synth.connect(filter);
    synth.triggerAttack(yToNote(y));
    voices[id] = { synth, filter };
}
function updateVoice(id,x,y){
    const v = voices[id]; if(!v) return;
    v.synth.frequency.value = Tone.Frequency(yToNote(y));
    v.filter.frequency.value = xToFilter(x);
}
function stopVoice(id){
    const v = voices[id]; if(!v) return;
    v.synth.triggerRelease();
    delete voices[id];
}

document.addEventListener('pointerdown', e => startVoice(e.pointerId, e.clientX, e.clientY));
document.addEventListener('pointermove', e => updateVoice(e.pointerId, e.clientX, e.clientY));
document.addEventListener('pointerup', e => stopVoice(e.pointerId));
document.addEventListener('pointercancel', e => stopVoice(e.pointerId));
document.addEventListener('lostpointercapture', e => stopVoice(e.pointerId));

// media rendering and posts
function renderMedia(path){
    const ext=path.split('.').pop().toLowerCase();
    if(['jpg','jpeg','png'].includes(ext)) return `<div style="margin-top:10px;"><img src="${path}" alt="Post media" style="width:100%;border-radius:8px;"></div>`;
    if(ext==='mp4') return `<div style="margin-top:10px;"><video src="${path}" controls style="width:100%;border-radius:8px;"></video></div>`;
    return '';
}

function generatePost(){
    const names=['Emma','Liam','Olivia','Noah','Ava'];
    const texts=['Having a great day! üòä','Check out this amazing view! üåÖ','Coffee time ‚òï','Working on something exciting! üöÄ','Weekend vibes üéâ'];
    let media=null;
    if(typeof mediaList!=='undefined' && mediaList.length>0 && Math.random()>0.5) media=mediaList[Math.floor(Math.random()*mediaList.length)];
    return {id:postId++, name:names[Math.floor(Math.random()*names.length)], text:texts[Math.floor(Math.random()*texts.length)], time:'2 hours ago', media};
}

function createPost(postData){
    const postDiv=document.createElement('div'); postDiv.className='post'; postDiv.dataset.postId=postData.id;
    postDiv.innerHTML=`<div class="post-header"><div class="avatar">${postData.name[0]}</div><div><div><strong>${postData.name}</strong></div><div style="font-size:12px;color:#999;">${postData.time}</div></div></div>
    <div>${postData.text}</div>
    ${postData.media?renderMedia(postData.media):''}
    <div class="post-actions">
        <button class="action-btn like-btn">üëç Like</button>
        <button class="action-btn comment-btn">üí¨ Comment</button>
        <button class="action-btn share-btn">üì§ Share</button>
    </div>`;
    postDiv.querySelector('.like-btn').addEventListener('click',()=>{currentWaveform='sine'; postDiv.querySelector('.like-btn').classList.toggle('liked');});
    postDiv.querySelector('.comment-btn').addEventListener('click',()=>{currentWaveform='square';});
    postDiv.querySelector('.share-btn').addEventListener('click',()=>{currentWaveform='triangle';});
    return postDiv;
}

function loadMore(){if(isLoading) return; isLoading=true;
    const container=document.getElementById('posts-container'); const feed=document.querySelector('.feed');
    feed.setAttribute('aria-busy','true'); const skeletons=[];
    for(let i=0;i<5;i++){const skeleton=document.createElement('div'); skeleton.className='skeleton-post'; container.appendChild(skeleton); skeletons.push(skeleton);}
    setTimeout(()=>{
        skeletons.forEach(s=>{const post=createPost(generatePost()); s.replaceWith(post);});
        feed.setAttribute('aria-busy','false'); isLoading=false;
    },300);
}

window.addEventListener('DOMContentLoaded',()=>{
    const sentinel=document.getElementById('sentinel');
    const observer=new IntersectionObserver(entries=>{if(entries[0].isIntersecting) loadMore();},{rootMargin:'200px 0px'});
    observer.observe(sentinel);
    loadMore(); setTimeout(()=>loadMore(),100);
});
</script>
</body>
</html>
