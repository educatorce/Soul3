<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Melofeed</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Billabong&display=swap');
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;
      background:#121212;
      color:#eee;
      margin:0;
    }
    header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 20px;
      background:#1e1e1e;
      border-bottom:1px solid #333;
      position:sticky;
      top:0;
      z-index:1000;
    }
    header h1 {
      font-family:'Billabong',cursive;
      font-size:28px;
      margin:0;
      color:#fff;
    }
    .menu-container { position:relative; }
    .menu-icon { cursor:pointer; font-size:22px; color:#fff; }
    .dropdown {
      display:none; /* üîπ ahora arranca oculto */
      position:absolute;
      top:40px;
      right:0;
      background:#1e1e1e;
      border:1px solid #333;
      border-radius:6px;
      padding:10px;
      z-index:1001;
      flex-direction:column;
      gap:5px;
    }
    .feed { max-width:600px; margin:20px auto; }
    .post {
      background:#1e1e1e;
      border:1px solid #333;
      border-radius:8px;
      padding:10px;
      margin-bottom:15px;
    }
    .post-header {
      display:flex;
      align-items:center;
      margin-bottom:10px;
    }
    .avatar {
      width:40px;
      height:40px;
      border-radius:50%;
      background:#3a3a3a;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-right:10px;
    }
    .post-actions {
      display:flex;
      justify-content:space-around;
      margin-top:10px;
    }
    .post-actions button {
      background:none;
      border:none;
      cursor:pointer;
      color:#eee;
      font-size:16px;
    }
    .post-actions button:hover { color:#ff4081; }
    .post * { user-select:none; }
    .skeleton-post {
      background:#1e1e1e;
      border-radius:8px;
      padding:15px;
      margin-bottom:15px;
      height:150px;
      animation:pulse 1.5s infinite;
      border:1px solid #333;
    }
    @keyframes pulse {
      0%{opacity:0.6;}50%{opacity:1;}100%{opacity:0.6;}
    }
    video {
      width:100%;
      border-radius:8px;
      cursor:pointer;
    }
    /* üîπ im√°genes ahora se adaptan bien al m√≥vil */
    .post img {
      max-width:100%;
      height:auto;
      border-radius:8px;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>Melofeed</h1>
    <div class="menu-container">
      <span class="menu-icon">‚ò∞</span>
      <div class="dropdown">
        <!-- selects y opciones id√©nticas a tu c√≥digo -->
        <select id="instrumentSelect">
          <option value="Synth">Synth</option>
          <option value="AMSynth">AMSynth</option>
          <option value="FMSynth">FMSynth</option>
          <option value="DuoSynth">DuoSynth</option>
        </select>
        <select id="effectSelect">
          <option value="none">No Effect</option>
          <option value="reverb">Reverb</option>
          <option value="chorus">Chorus</option>
          <option value="distortion">Distortion</option>
          <option value="tremolo">Tremolo</option>
          <option value="vibrato">Vibrato</option>
          <option value="delay">Delay</option>
        </select>
        <select id="scaleSelect">
          <option value="major">Major</option>
          <option value="minor">Minor</option>
          <option value="dorian">Dorian</option>
          <option value="phrygian">Phrygian</option>
          <option value="lydian">Lydian</option>
          <option value="mixolydian">Mixolydian</option>
          <option value="locrian">Locrian</option>
          <option value="harmonicMinor">Harmonic Minor</option>
          <option value="pentatonicMajor">Pentatonic Major</option>
          <option value="pentatonicMinor">Pentatonic Minor</option>
        </select>
        <select id="tonalitySelect">
          <option value="C">C</option><option value="C#">C#</option><option value="D">D</option>
          <option value="D#">D#</option><option value="E">E</option><option value="F">F</option>
          <option value="F#">F#</option><option value="G">G</option><option value="G#">G#</option>
          <option value="A">A</option><option value="A#">A#</option><option value="B">B</option>
        </select>
        <input type="number" id="arpeggioBPM" placeholder="BPM" value="120">
        <select id="arpeggioType">
          <option value="up">Ascending</option>
          <option value="down">Descending</option>
          <option value="random">Random</option>
        </select>
      </div>
    </div>
  </header>
  <main class="feed" id="feed"></main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
  <script src="media-list.js"></script>
  <script>
    const feed=document.getElementById("feed");
    let postId=0,isLoading=false;
    let synth,effectNode;
    let activeTouches={},arpeggioInterval=null;

    // scales y tonalities igual que tu c√≥digo...
    const scales={ major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],
      dorian:[0,2,3,5,7,9,10],phrygian:[0,1,3,5,7,8,10],lydian:[0,2,4,6,7,9,11],
      mixolydian:[0,2,4,5,7,9,10],locrian:[0,1,3,5,6,8,10],harmonicMinor:[0,2,3,5,7,8,11],
      pentatonicMajor:[0,2,4,7,9],pentatonicMinor:[0,3,5,7,10]};
    const tonalities=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    let currentScale="major",currentTonality="C";

    function createSynth(type="Synth"){if(synth) synth.dispose(); synth=new Tone[type]().toDestination();}
    function applyEffect(type){if(effectNode){effectNode.dispose(); synth.connect(Tone.Destination);}
      if(type!=="none"){switch(type){case"reverb":effectNode=new Tone.Reverb().toDestination();break;
        case"chorus":effectNode=new Tone.Chorus().toDestination();break;
        case"distortion":effectNode=new Tone.Distortion(0.4).toDestination();break;
        case"tremolo":effectNode=new Tone.Tremolo().start().toDestination();break;
        case"vibrato":effectNode=new Tone.Vibrato().toDestination();break;
        case"delay":effectNode=new Tone.FeedbackDelay("8n",0.5).toDestination();break;}
        synth.connect(effectNode);}}
    createSynth("Synth");

    document.getElementById("instrumentSelect").addEventListener("change",e=>{createSynth(e.target.value);applyEffect(document.getElementById("effectSelect").value);});
    document.getElementById("effectSelect").addEventListener("change",e=>applyEffect(e.target.value));
    document.getElementById("scaleSelect").addEventListener("change",e=>currentScale=e.target.value);
    document.getElementById("tonalitySelect").addEventListener("change",e=>currentTonality=e.target.value);

    function getNoteFromY(y){const h=window.innerHeight; const pos=1-(y/h);
      const scale=scales[currentScale]; const tIndex=tonalities.indexOf(currentTonality);
      const totalNotes=scale.length*2; const idx=Math.floor(pos*totalNotes);
      const octave=3+Math.floor(idx/scale.length);
      const semitone=(scale[idx%scale.length]+tIndex)%12;
      return tonalities[semitone]+octave;}

    function renderMedia(path){const ext=path.split(".").pop().toLowerCase();
      if(["jpg","jpeg","png"].includes(ext)) return `<img src="${path}" alt="Post media">`;
      else if(ext==="mp4") return `<video src="${path}" preload="metadata" muted></video>`;
      else return "";}

    function generatePost(){if(typeof mediaList==="undefined"||mediaList.length===0) return null;
      let media=null,attempts=0;
      while(attempts<5){const c=mediaList[Math.floor(Math.random()*mediaList.length)];
        if(c){media=c;break;} attempts++;} if(!media) return null;
      const names=['Emma','Liam','Olivia','Noah','Ava'];
      const texts=['Having a great day!','Check this view!','Coffee time','Working on something','Weekend vibes'];
      return {id:postId++,name:names[Math.floor(Math.random()*names.length)],text:texts[Math.floor(Math.random()*texts.length)],time:'2 hours ago',media:media};}

    function createPost(data){if(!data) return null;
      const post=document.createElement("div"); post.className="post";
      post.innerHTML=`<div class="post-header"><div class="avatar">${data.name[0]}</div><div><div><strong>${data.name}</strong></div><div style="font-size:12px;color:#999;">${data.time}</div></div></div>
      <div>${data.text}</div>${data.media?renderMedia(data.media):""}<div class="post-actions"><button>üëç Like</button><button>üí¨ Comment</button><button>üì§ Share</button></div>`;
      const video=post.querySelector("video"); if(video){video.addEventListener("click",()=>{video.muted=false;video.play();});}
      feed.appendChild(post); return post;}

    function loadMore(){if(isLoading) return; isLoading=true;
      // üîπ agrega skeletons antes de cargar posts
      for(let i=0;i<3;i++){const s=document.createElement("div"); s.className="skeleton-post"; feed.appendChild(s);}
      setTimeout(()=>{const skeletons=document.querySelectorAll(".skeleton-post"); skeletons.forEach(s=>s.remove());
        for(let i=0;i<5;i++){const data=generatePost(); if(data) createPost(data);} isLoading=false;},1000);}
    window.addEventListener("DOMContentLoaded",()=>{loadMore();
      const sentinel=document.createElement("div"); feed.appendChild(sentinel);
      const obs=new IntersectionObserver(e=>{if(e[0].isIntersecting) loadMore();},{rootMargin:"200px 0px"});
      obs.observe(sentinel);});

    function startTouch(y,x,id){Tone.start(); activeTouches[id]={y:y,x:x,osc:null};
      if(Object.keys(activeTouches).length===2){if(arpeggioInterval){clearInterval(arpeggioInterval);arpeggioInterval=null;return;}
        const firstY=Math.min(...Object.values(activeTouches).map(t=>t.y)); startArpeggio(firstY); return;}
      const note=getNoteFromY(y); const osc=new Tone.Synth().toDestination();
      osc.triggerAttack(note); activeTouches[id].osc=osc;}

    function updateTouch(y,x,id){if(activeTouches[id]&&activeTouches[id].osc){const note=getNoteFromY(y); activeTouches[id].osc.setNote(note);}}

    function endTouch(id){if(activeTouches[id]){if(activeTouches[id].osc){activeTouches[id].osc.triggerRelease(); activeTouches[id].osc.dispose();}
      delete activeTouches[id];}
      // üîπ ahora solo corta el arpeggiador si no hay dedos activos
      if(Object.keys(activeTouches).length===0 && arpeggioInterval){clearInterval(arpeggioInterval); arpeggioInterval=null;}}

    function startArpeggio(baseY){const scale=scales[currentScale]; const tIndex=tonalities.indexOf(currentTonality);
      const h=window.innerHeight; const pos=1-(baseY/h); const totalNotes=scale.length*2;
      const baseIndex=Math.floor(pos*totalNotes); let idx=baseIndex;
      const notes=[]; for(let i=0;i<8;i++){const octave=3+Math.floor(idx/scale.length);
        const semitone=(scale[idx%scale.length]+tIndex)%12; notes.push(tonalities[semitone]+octave); idx+=2;}
      const bpm=parseInt(document.getElementById("arpeggioBPM").value)||120; const intervalMs=60000/bpm;
      let nIdx=0; const type=document.getElementById("arpeggioType").value;
      arpeggioInterval=setInterval(()=>{synth.triggerRelease(); synth.triggerAttackRelease(notes[nIdx],"8n");
        if(type==="up") nIdx=(nIdx+1)%notes.length; else if(type==="down") nIdx=(nIdx-1+notes.length)%notes.length;
        else if(type==="random") nIdx=Math.floor(Math.random()*notes.length);},intervalMs);}

    window.addEventListener("mousedown",e=>startTouch(e.clientY,e.clientX,"mouse"));
    window.addEventListener("mousemove",e=>updateTouch(e.clientY,e.clientX,"mouse"));
    window.addEventListener("mouseup",e=>endTouch("mouse"));
    window.addEventListener("touchstart",e=>{for(const t of e.touches) startTouch(t.clientY,t.clientX,t.identifier);});
    window.addEventListener("touchmove",e=>{for(const t of e.touches) updateTouch(t.clientY,t.clientX,t.identifier);});
    window.addEventListener("touchend",e=>{for(const t of e.changedTouches) endTouch(t.identifier);});

    document.querySelector(".menu-icon").addEventListener("click",()=>{const d=document.querySelector(".dropdown"); d.style.display=(d.style.display==="flex")?"none":"flex";});
  </script>
</body>
</html>
