<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Melodic Feed</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Billabong&display=swap');

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #121212;
      color: #eee;
      margin: 0;
      padding: 0;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background-color: #1e1e1e;
      border-bottom: 1px solid #333;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    header h1 {
      font-family: 'Billabong', cursive;
      font-size: 28px;
      margin: 0;
      color: #fff;
    }

    .feed {
      max-width: 600px;
      margin: 20px auto;
      padding: 0;
    }

    .post {
      max-width: 100%;
      margin-bottom: 20px;
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    .post img, .post video {
      max-width: 100%;
      border-radius: 8px;
      display: block;
      margin-top: 10px;
    }

    .actions {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
    }

    .actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: #eee;
      font-size: 18px;
    }

    .actions button:hover {
      color: #ff4081;
    }

    .skeleton-post {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      height: 150px;
      animation: pulse 1.5s infinite;
      border: 1px solid #333;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Melofeed</h1>
  </header>

  <main class="feed" id="feed">
    <div id="posts-container"></div>
    <div id="sentinel"></div>
  </main>

  <!-- Cargar lista externa de media -->
  <script src="media-list.js"></script> <!-- mediaList debe ser un array global -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
  <script>
    const feed = document.getElementById('posts-container');

    // --- Tone.js Setup ---
    let synth, filter, effectNode;
    const lowPass = new Tone.Filter(20000, "lowpass").toDestination();

    function createSynth(type="Synth") {
      if (synth) synth.dispose();
      synth = new Tone[type]().connect(lowPass);
    }

    createSynth("Synth");

    // --- Escalas ---
    const scales = {
      major: [0,2,4,5,7,9,11],
      minor: [0,2,3,5,7,8,10],
      dorian: [0,2,3,5,7,9,10],
      phrygian: [0,1,3,5,7,8,10],
      lydian: [0,2,4,6,7,9,11],
      mixolydian: [0,2,4,5,7,9,10],
      locrian: [0,1,3,5,6,8,10],
      harmonicMinor: [0,2,3,5,7,8,11],
      pentatonicMajor: [0,2,4,7,9],
      pentatonicMinor: [0,3,5,7,10]
    };
    const tonalities = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    let currentScale = "major";
    let currentTonality = "C";

    // --- Variables de posts ---
    let postId = 0;
    let isLoading = false;

    function generatePost() {
      const names = ['Emma', 'Liam', 'Olivia', 'Noah', 'Ava'];
      const texts = [
        'Having a great day! üòä',
        'Check out this amazing view! üåÖ',
        'Coffee time ‚òï',
        'Working on something exciting! üöÄ',
        'Weekend vibes üéâ'
      ];

      let media = null;
      if (typeof mediaList !== "undefined" && mediaList.length > 0 && Math.random() > 0.5) {
        media = mediaList[Math.floor(Math.random() * mediaList.length)];
      }

      return {
        id: postId++,
        name: names[Math.floor(Math.random() * names.length)],
        text: texts[Math.floor(Math.random() * texts.length)],
        time: '2 hours ago',
        media: media
      };
    }

    function renderMedia(filePath) {
      const ext = filePath.split('.').pop().toLowerCase();
      if (["jpg","jpeg","png"].includes(ext)) {
        return `<img src="${filePath}" alt="Post media">`;
      } else if (ext === "mp4") {
        return `<video src="${filePath}" controls></video>`;
      } else {
        return "";
      }
    }

    function createPost(postData) {
      const postDiv = document.createElement('div');
      postDiv.className = 'post';
      postDiv.dataset.postId = postData.id;
      postDiv.innerHTML = `
        <div><strong>${postData.name}</strong> ‚Ä¢ <small>${postData.time}</small></div>
        <div>${postData.text}</div>
        ${postData.media ? renderMedia(postData.media) : ""}
        <div class="actions">
          <button class="like-btn">‚ù§Ô∏è</button>
          <button>üí¨</button>
          <button>üîó</button>
        </div>
      `;

      postDiv.querySelector('.like-btn').addEventListener('click', () => {
        postDiv.querySelector('.like-btn').classList.toggle('liked');
        playNote();
      });

      return postDiv;
    }

    // --- Audio ---
    let audioContext = null;
    let masterGain = null;
    let isAudioEnabled = true;

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioContext.createGain();
        masterGain.connect(audioContext.destination);
        masterGain.gain.value = 0.5;
      }
    }

    function playNote() {
      if (!isAudioEnabled || !audioContext) return;
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain);
      gain.connect(masterGain);
      osc.frequency.value = 440 + Math.random() * 200;
      osc.type = 'sine';
      const now = audioContext.currentTime;
      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(0.2, now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
      osc.start(now);
      osc.stop(now + 0.5);
    }

    // --- Scroll infinito ---
    function loadMore() {
      if (isLoading) return;
      isLoading = true;

      const skeletons = [];
      for (let i = 0; i < 3; i++) {
        const skeleton = document.createElement('div');
        skeleton.className = 'skeleton-post';
        feed.appendChild(skeleton);
        skeletons.push(skeleton);
      }

      setTimeout(() => {
        skeletons.forEach(skeleton => {
          const postData = generatePost();
          const postEl = createPost(postData);
          skeleton.replaceWith(postEl);
        });
        isLoading = false;
      }, 500);
    }

    const sentinel = document.createElement('div');
    feed.appendChild(sentinel);

    const observer = new IntersectionObserver(
      entries => {
        if (entries[0].isIntersecting) loadMore();
      },
      { rootMargin: '200px 0px' }
    );
    observer.observe(sentinel);

    window.addEventListener('DOMContentLoaded', () => {
      initAudio();
      loadMore();
    });
  </script>
</body>
</html>
