<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Melodic Feed Theremin Mobile</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Billabong&display=swap');
body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif; margin:0; background:#121212; color:#e0e0e0; overflow-x:hidden; }
.header { background:#1f1f1f; padding:10px; box-shadow:0 1px 3px rgba(0,0,0,0.7); position:sticky; top:0; z-index:100; display:flex; align-items:center; gap:5px; flex-wrap:wrap; }
.header h1 { font-family:'Billabong',cursive; font-size:32px; color:#e0e0e0; margin:0; flex:1; }
.menu-btn { background:none;border:none;color:#e0e0e0;font-size:22px;cursor:pointer; }
.dropdown { display:none; position:absolute; top:40px; left:0; background:#1f1f1f; padding:10px; border-radius:8px; z-index:200; max-width:180px; }
.dropdown label, .dropdown select, .dropdown input { color:#e0e0e0; margin-right:5px; font-size:14px; }
.feed { max-width:600px; margin:20px auto; padding:0; }
.post { background:#1e1e1e; border-radius:8px; padding:15px; margin-bottom:15px; box-shadow:0 0 1px rgba(0,0,0,0.5); border:1px solid #333; }
.post-header { display:flex; align-items:center; margin-bottom:10px; }
.avatar { width:40px; height:40px; border-radius:50%; background:#3a3a3a; color:#fff; display:flex; align-items:center; justify-content:center; margin-right:10px; }
.post-actions { display:flex; gap:10px; margin-top:10px; padding-top:10px; border-top:1px solid #444; }
.action-btn { flex:1; padding:8px; border:none; background:none; cursor:pointer; color:#b3b3b3; font-weight:bold; text-align:center; font-size:14px; }
.action-btn:hover { background:#333; border-radius:4px; }
.action-btn.liked { color:#ed4956; }
.skeleton-post { background:#1e1e1e; border-radius:8px; padding:15px; margin-bottom:15px; height:150px; animation:pulse 1.5s infinite; border:1px solid #333; }
@keyframes pulse {0%{opacity:0.6}50%{opacity:1}100%{opacity:0.6}}
#touch-visuals { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:300; }
img, video { user-select:none; -webkit-user-drag:none; touch-action:none; }
#note-display { position:fixed; top:10px; right:10px; color:#ff5f6d; font-size:18px; font-weight:bold; z-index:400; }
</style>
</head>
<body>

<div class="header">
  <h1>üéµ MeloFeed</h1>
  <div style="position:relative;"><button class="menu-btn" id="menu-instr">üéπ</button>
    <div class="dropdown" id="instr-dropdown">
      <label>Instrument:</label>
      <select id="instrument-select">
        <option value="Synth">Synth (Sine)</option>
        <option value="AMSynth">AMSynth</option>
        <option value="FMSynth">FMSynth</option>
        <option value="MembraneSynth">MembraneSynth</option>
      </select>
    </div>
  </div>
  <div style="position:relative;"><button class="menu-btn" id="menu-effects">üéõÔ∏è</button>
    <div class="dropdown" id="effects-dropdown">
      <label><input type="checkbox" class="effect-toggle" value="Reverb"> Reverb</label><br>
      <label><input type="checkbox" class="effect-toggle" value="Chorus"> Chorus</label><br>
      <label><input type="checkbox" class="effect-toggle" value="Distortion"> Distortion</label><br>
      <label><input type="checkbox" class="effect-toggle" value="Tremolo"> Tremolo</label><br>
      <label><input type="checkbox" class="effect-toggle" value="Vibrato"> Vibrato</label><br>
      <label><input type="checkbox" class="effect-toggle" value="Delay"> Delay</label>
    </div>
  </div>
  <div style="position:relative;"><button class="menu-btn" id="menu-scale">üéº</button>
    <div class="dropdown" id="scale-dropdown">
      <label>Scale:</label>
      <select id="scale-select">
        <option>Major</option><option>Minor</option><option>Pentatonic</option>
        <option>Major Pentatonic</option><option>Minor Pentatonic</option>
        <option>Harmonic Minor</option><option>Dorian</option><option>Phrygian</option>
        <option>Lydian</option><option>Mixolydian</option><option>Aeolian</option>
        <option>Locrian</option>
      </select>
    </div>
  </div>
  <div style="position:relative;"><button class="menu-btn" id="menu-tonic">üéµ</button>
    <div class="dropdown" id="tonic-dropdown">
      <select id="tonic-select">
        <option>C</option><option>C#</option><option>D</option><option>D#</option>
        <option>E</option><option>F</option><option>F#</option><option>G</option>
        <option>G#</option><option>A</option><option>A#</option><option>B</option>
      </select>
    </div>
  </div>
</div>

<div class="feed" role="feed" aria-live="polite">
  <div id="posts-container"></div>
  <div id="sentinel"></div>
</div>

<div id="touch-visuals"></div>
<div id="note-display"></div>

<script src="https://cdn.jsdelivr.net/npm/tone@next/build/Tone.js"></script>
<script src="media-list.js"></script>
<script>
let postId=0,isLoading=false;
let voices={},maxVoices=1;
let selectedInstrument='Synth',selectedScale='Pentatonic',selectedTonic='C';
let enabledEffects={};
const scales = {
    Major:[0,2,4,5,7,9,11,12],
    Minor:[0,2,3,5,7,8,10,12],
    Dorian:[0,2,3,5,7,9,10,12],
    Phrygian:[0,1,3,5,7,8,10,12],
    Lydian:[0,2,4,6,7,9,11,12],
    Mixolydian:[0,2,4,5,7,9,10,12],
    Aeolian:[0,2,3,5,7,8,10,12],
    Locrian:[0,1,3,5,6,8,10,12],
    'Harmonic Minor':[0,2,3,5,7,8,11,12],
    'Major Pentatonic':[0,2,4,7,9,12],
    'Minor Pentatonic':[0,3,5,7,10,12]
};

const menuMap={'menu-instr':'instr-dropdown','menu-effects':'effects-dropdown','menu-scale':'scale-dropdown','menu-tonic':'tonic-dropdown'};
for(const btnId in menuMap){
    const btn=document.getElementById(btnId);
    const dd=document.getElementById(menuMap[btnId]);
    btn.addEventListener('click',()=>{
        for(const otherId in menuMap){
            if(otherId!==btnId) document.getElementById(menuMap[otherId]).style.display='none';
        }
        dd.style.display = dd.style.display==='none'?'block':'none';
    });
}

document.getElementById('instrument-select').addEventListener('change',e=>selectedInstrument=e.target.value);
document.getElementById('scale-select').addEventListener('change',e=>selectedScale=e.target.value);
document.getElementById('tonic-select').addEventListener('change',e=>selectedTonic=e.target.value);

// One effect at a time
document.querySelectorAll('.effect-toggle').forEach(cb=>{
    cb.addEventListener('change', e=>{
        if(e.target.checked){
            document.querySelectorAll('.effect-toggle').forEach(other=>{if(other!==e.target) other.checked=false;});
            enabledEffects = {}; enabledEffects[e.target.value]=true;
        } else {
            enabledEffects[e.target.value]=false;
        }
    });
});

const isMobile=/Mobi|Android/i.test(navigator.userAgent);
const touchVisuals=document.getElementById('touch-visuals');
const noteDisplay=document.getElementById('note-display');

function showTouch(id,x,y){
  const c=document.createElement('div'); c.id='tv-'+id; c.style.position='absolute';
  c.style.width='30px'; c.style.height='30px'; c.style.background='#ff5f6d';
  c.style.borderRadius='50%'; c.style.left=(x-15)+'px'; c.style.top=(y-15)+'px';
  c.style.opacity='0.7'; c.style.pointerEvents='none'; touchVisuals.appendChild(c);
  setTimeout(()=>c.remove(),500);
}

function yToNote(y){
    const norm = 1 - Math.min(Math.max(y / window.innerHeight,0),1);
    const scaleIntervals = scales[selectedScale];
    const totalSteps = scaleIntervals.length * 2;
    const stepIndex = Math.floor(norm*(totalSteps-1));
    const octaveShift = Math.floor(stepIndex/scaleIntervals.length)*12;
    const scaleStep = scaleIntervals[stepIndex % scaleIntervals.length];
    const tonicMidi = Tone.Frequency(selectedTonic+'3').toMidi();
    const noteMidi = tonicMidi + scaleStep + octaveShift;
    return Tone.Frequency(noteMidi,'midi').toNote();
}

function xToFilter(x){
    const norm = Math.min(Math.max(x/window.innerWidth,0),1);
    return 200 + norm*(8000-200);
}

function updateNoteDisplay(note){ noteDisplay.textContent=note; }

function createSynthWithEffects(){
  let synth;
  switch(selectedInstrument){
    case 'AMSynth': synth=new Tone.AMSynth(); break;
    case 'FMSynth': synth=new Tone.FMSynth(); break;
    case 'MembraneSynth': synth=new Tone.MembraneSynth(); break;
    default: synth=new Tone.Synth({oscillator:{type:'sine'}});
  }
  let lastNode=synth;
  for(const effect in enabledEffects){
    if(enabledEffects[effect]){
      switch(effect){
        case 'Reverb': const r=new Tone.Reverb(2); lastNode.connect(r); lastNode=r; break;
        case 'Chorus': const c=new Tone.Chorus(4,2.5,0.5).start(); lastNode.connect(c); lastNode=c; break;
        case 'Distortion': const d=new Tone.Distortion(0.4); lastNode.connect(d); lastNode=d; break;
        case 'Tremolo': const t=new Tone.Tremolo(9,0.75).start(); lastNode.connect(t); lastNode=t; break;
        case 'Vibrato': const v=new Tone.Vibrato(5,0.1).start(); lastNode.connect(v); lastNode=v; break;
        case 'Delay': const l=new Tone.FeedbackDelay("8n",0.5); lastNode.connect(l); lastNode=l; break;
      }
    }
  }
  lastNode.toDestination();
  return synth;
}

function startVoice(id,x,y){
  if(voices[id]) return;
  const synth = createSynthWithEffects();
  const filter = new Tone.Filter(xToFilter(x),'lowpass').toDestination();
  synth.connect(filter);
  const note=yToNote(y);
  synth.triggerAttack(note);
  voices[id]={synth,filter,note};
  updateNoteDisplay(note);
}

function updateVoice(id,x,y){
  if(!voices[id]) return;
  const note=yToNote(y);
  const filter=xToFilter(x);
  voices[id].synth.frequency.rampTo(Tone.Frequency(note).toFrequency(),0.05);
  voices[id].filter.frequency.value=filter;
  voices[id].note=note;
  updateNoteDisplay(note);
}

function stopVoice(id){
  if(!voices[id]) return;
  voices[id].synth.triggerRelease();
  delete voices[id];
  noteDisplay.textContent='';
}

// üîπ Post generation
function generatePost(){
  const names=['Emma','Liam','Olivia','Noah','Ava'];
  const texts=['Having a great day! üòä','Check out this amazing view! üåÖ','Coffee time ‚òï','Working on something exciting! üöÄ','Weekend vibes üéâ'];
  let media=null;
  if(typeof mediaList!=='undefined' && mediaList.length>0 && Math.random()>0.5) media=mediaList[Math.floor(Math.random()*mediaList.length)];
  return {id:postId++,name:names[Math.floor(Math.random()*names.length)],text:texts[Math.floor(Math.random()*texts.length)],time:'2 hours ago',media};
}

function renderMedia(filePath){
  const ext=filePath.split('.').pop().toLowerCase();
  if(["jpg","jpeg","png"].includes(ext)) return `<div style="margin-top:10px;"><img src="${filePath}" alt="Post media" style="width:100%;border-radius:8px;"></div>`;
  if(ext==='mp4') return `<div style="margin-top:10px;"><video src="${filePath}" controls style="width:100%;border-radius:8px;"></video></div>`;
  return '';
}

function createPost(postData){
  const postDiv=document.createElement('div'); postDiv.className='post'; postDiv.dataset.postId=postData.id;
  postDiv.innerHTML=`<div class="post-header"><div class="avatar">${postData.name[0]}</div><div><div><strong>${postData.name}</strong></div><div style="font-size:12px;color:#999;">${postData.time}</div></div></div><div>${postData.text}</div>${postData.media?renderMedia(postData.media):''}<div class="post-actions"><button class="action-btn like-btn" role="button" tabindex="0" aria-pressed="false">üëç Like</button><button class="action-btn" role="button" tabindex="0">üí¨ Comment</button><button class="action-btn" role="button" tabindex="0">üì§ Share</button></div>`;
  return postDiv;
}

function loadMore(){
  if(isLoading) return; isLoading=true;
  const container=document.getElementById('posts-container');
  const feed=document.querySelector('.feed'); feed.setAttribute('aria-busy','true');
  const skeletons=[];
  for(let i=0;i<5;i++){ const s=document.createElement('div'); s.className='skeleton-post'; container.appendChild(s); skeletons.push(s);}
  setTimeout(()=>{
    skeletons.forEach(s=>{
      const postData=generatePost();
      const postElement=createPost(postData);
      s.replaceWith(postElement);
    });
    feed.setAttribute('aria-busy','false'); isLoading=false;
  },800);
}

window.addEventListener('DOMContentLoaded',()=>{
  const sentinel=document.getElementById('sentinel'); 
  const observer=new IntersectionObserver(entries=>{ if(entries[0].isIntersecting) loadMore(); },{rootMargin:'200px 0px'});
  observer.observe(sentinel); loadMore(); setTimeout(()=>loadMore(),100);

  // Touch Theremin
  document.addEventListener('pointerdown', e=>{
    if(e.target.closest('.post img, .post video')) return;
    e.preventDefault(); Tone.start(); startVoice('main',e.clientX,e.clientY); showTouch('main',e.clientX,e.clientY);
  });
  document.addEventListener('pointermove', e=>{
    if(voices['main']){ e.preventDefault(); updateVoice('main',e.clientX,e.clientY); showTouch('main',e.clientX,e.clientY);}
  });
  document.addEventListener('pointerup', e=>{ stopVoice('main'); });
});
</script>
</body>
</html>
