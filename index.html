<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Melodic Feed</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Billabong&display=swap');

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fafafa;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: white;
      border-bottom: 1px solid #dbdbdb;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      font-family: 'Billabong', cursive;
      font-size: 28px;
      margin: 0;
    }

    #feed {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .post {
      width: 100%;
      max-width: 600px;
      margin: 20px 0;
      background: white;
      border: 1px solid #dbdbdb;
      border-radius: 8px;
      overflow: hidden;
    }

    .post-header {
      display: flex;
      align-items: center;
      padding: 10px;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .username {
      font-weight: bold;
    }

    .post img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      cursor: pointer;
    }

    .post video {
      width: 100%;
      height: auto;
      border-radius: 8px;
      cursor: pointer;
    }

    .post-actions {
      display: flex;
      padding: 8px;
    }

    .post-actions button {
      background: none;
      border: none;
      cursor: pointer;
      margin-right: 10px;
    }

    .post-description {
      padding: 0 10px 10px 10px;
    }

    /* dropdown empieza oculto */
    .dropdown {
      display: none;
      position: absolute;
      right: 10px;
      top: 50px;
      background: white;
      border: 1px solid #dbdbdb;
      border-radius: 8px;
      padding: 10px;
      flex-direction: column;
      gap: 5px;
    }

    #instrument {
      width: 100%;
      height: 300px;
      background: #eee;
      margin: 20px 0;
      touch-action: none;
      position: relative;
    }

    .skeleton-post {
      width: 100%;
      max-width: 600px;
      height: 400px;
      background: #ddd;
      border-radius: 8px;
      margin: 20px 0;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Melodic Feed</h1>
    <div>
      <button onclick="toggleDropdown()">â˜°</button>
      <div id="menu" class="dropdown">
        <button onclick="setScale('major')">Major Scale</button>
        <button onclick="setScale('minor')">Minor Scale</button>
        <button onclick="setArpeggio('up')">Arpeggio Up</button>
        <button onclick="setArpeggio('down')">Arpeggio Down</button>
        <button onclick="setArpeggio('random')">Arpeggio Random</button>
        <button onclick="toggleEffect('chorus')">Chorus</button>
        <button onclick="toggleEffect('reverb')">Reverb</button>
        <button onclick="toggleEffect('distortion')">Distortion</button>
      </div>
    </div>
  </header>

  <div id="feed"></div>
  <div id="instrument"></div>

  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.39/build/Tone.js"></script>
  <script>
    const posts = [
      {user:"Alice", avatar:"https://via.placeholder.com/32", media:"https://www.w3schools.com/html/mov_bbb.mp4", description:"Beautiful day!", type:"video"},
      {user:"Bob", avatar:"https://via.placeholder.com/32", media:"https://picsum.photos/400/300", description:"Look at this!", type:"image"},
      {user:"Charlie", avatar:"https://via.placeholder.com/32", media:"https://picsum.photos/400/301", description:"Another post", type:"image"},
    ];

    let feed = document.getElementById('feed');
    let postIndex = 0;

    function createPost(p){
      let div = document.createElement('div');
      div.className="post";
      let header = document.createElement('div');
      header.className="post-header";
      header.innerHTML = '<img class="avatar" src="'+p.avatar+'"><span class="username">'+p.user+'</span>';
      div.appendChild(header);
      if(p.type==="image"){
        let img=document.createElement('img');
        img.src=p.media;
        div.appendChild(img);
      } else {
        let vid=document.createElement('video');
        vid.src=p.media;
        vid.controls=true;
        div.appendChild(vid);
      }
      let actions=document.createElement('div');
      actions.className="post-actions";
      actions.innerHTML='<button>â™¥</button><button>ðŸ’¬</button><button>â†—</button>';
      div.appendChild(actions);
      let desc=document.createElement('div');
      desc.className="post-description";
      desc.innerText=p.description;
      div.appendChild(desc);
      return div;
    }

    function loadPosts(){
      for(let i=0;i<2;i++){
        if(postIndex<posts.length){
          feed.appendChild(createPost(posts[postIndex++]));
        }
      }
    }

    loadPosts();

    let observer=new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          let skeleton=document.createElement('div');
          skeleton.className="skeleton-post";
          feed.appendChild(skeleton);
          setTimeout(()=>{
            feed.removeChild(skeleton);
            loadPosts();
          },1000);
        }
      });
    });
    observer.observe(document.querySelector('footer')||document.body.appendChild(document.createElement('footer')));

    function toggleDropdown(){
      let menu=document.getElementById('menu');
      menu.style.display=menu.style.display==='flex'?'none':'flex';
    }

    const instrument=document.getElementById('instrument');
    let activeTouches={};
    let scaleType="major";
    let arpeggioType="up";
    let effects={chorus:null,reverb:null,distortion:null};
    let synth=createSynth();
    let arpeggioInterval=null;

    function createSynth(){
      let s=new Tone.Synth().toDestination();
      return s;
    }

    function setScale(type){ scaleType=type; }
    function setArpeggio(type){ arpeggioType=type; }
    function toggleEffect(name){
      if(effects[name]){
        effects[name].dispose();
        effects[name]=null;
      } else {
        if(name==="chorus") effects[name]=new Tone.Chorus().toDestination().start();
        if(name==="reverb") effects[name]=new Tone.Reverb().toDestination();
        if(name==="distortion") effects[name]=new Tone.Distortion(0.4).toDestination();
      }
    }

    function getNotes(){
      return scaleType==="major"?["C4","D4","E4","F4","G4","A4","B4","C5"]:["C4","D4","Eb4","F4","G4","Ab4","Bb4","C5"];
    }

    instrument.addEventListener('touchstart',(e)=>{
      e.preventDefault();
      for(let touch of e.changedTouches){
        startTouch(touch.identifier,touch.clientX,touch.clientY);
      }
    },{passive:false});

    instrument.addEventListener('touchmove',(e)=>{
      e.preventDefault();
      for(let touch of e.changedTouches){
        moveTouch(touch.identifier,touch.clientX,touch.clientY);
      }
    },{passive:false});

    instrument.addEventListener('touchend',(e)=>{
      e.preventDefault();
      for(let touch of e.changedTouches){
        endTouch(touch.identifier);
      }
    },{passive:false});

    function startTouch(id,x,y){
      let notes=getNotes();
      let note=notes[Math.floor((y/instrument.clientHeight)*notes.length)];
      let osc=new Tone.Synth().toDestination();
      osc.triggerAttack(note);
      activeTouches[id]={osc:osc,note:note};

      if(Object.keys(activeTouches).length===2){
        startArpeggio();
      }
    }

    function moveTouch(id,x,y){
      if(activeTouches[id]){
        let notes=getNotes();
        let note=notes[Math.floor((y/instrument.clientHeight)*notes.length)];
        if(note!==activeTouches[id].note){
          activeTouches[id].osc.triggerRelease();
          activeTouches[id].osc.dispose();
          let osc=new Tone.Synth().toDestination();
          osc.triggerAttack(note);
          activeTouches[id]={osc:osc,note:note};
        }
      }
    }

    function endTouch(id){
      if(activeTouches[id]){
        activeTouches[id].osc.triggerRelease();
        activeTouches[id].osc.dispose();
        delete activeTouches[id];
      }
      // mejora: solo detener arpegiador si no quedan dedos
      if(Object.keys(activeTouches).length===0 && arpeggioInterval){
        clearInterval(arpeggioInterval);
        arpeggioInterval=null;
      }
    }

    function startArpeggio(){
      if(arpeggioInterval) return;
      let notes=getNotes();
      let i=0;
      arpeggioInterval=setInterval(()=>{
        let note;
        if(arpeggioType==="up") note=notes[i%notes.length];
        if(arpeggioType==="down") note=notes[notes.length-(i%notes.length)-1];
        if(arpeggioType==="random") note=notes[Math.floor(Math.random()*notes.length)];
        synth.triggerAttackRelease(note,"8n");
        i++;
      },300);
    }
  </script>
</body>
</html>
