<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Melodic Feed Theremin</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #111;
      color: #fff;
    }
    header {
      background: #222;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
    }
    .feed {
      max-width: 600px;
      margin: 1rem auto;
    }
    .post {
      background: #1e1e1e;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 12px;
    }
    .skeleton {
      background: #333;
      height: 120px;
      border-radius: 12px;
      margin-bottom: 1rem;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
  </style>
</head>
<body>
  <header>Melodic Feed Theremin</header>
  <main class="feed" id="feed"></main>

  <script>
    // ====== Audio Setup ======
    let audioContext, masterGain;
    let thereminOsc, thereminGain, thereminFilter;
    let isPlaying = false;

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioContext.createGain();
        masterGain.gain.setValueAtTime(0.5, audioContext.currentTime);
        masterGain.connect(audioContext.destination);
      }
    }

    // Minor pentatonic scale in semitones
    const minorPentatonic = [0, 3, 5, 7, 10];

    function freqFromY(y) {
      const baseNote = 220; // A3
      const scaleDegree = Math.floor((1 - y) * 20) % minorPentatonic.length;
      const octave = Math.floor((1 - y) * 4);
      const semitone = minorPentatonic[scaleDegree] + octave * 12;
      return baseNote * Math.pow(2, semitone / 12);
    }

    function filterFromX(x) {
      return 200 + x * 4000; // 200Hz – 4200Hz
    }

    function startTheremin(x, y) {
      initAudio();
      if (isPlaying || !audioContext) return;

      thereminOsc = audioContext.createOscillator();
      thereminGain = audioContext.createGain();
      thereminFilter = audioContext.createBiquadFilter();

      thereminOsc.type = "sine";
      thereminFilter.type = "lowpass";

      thereminOsc.connect(thereminFilter);
      thereminFilter.connect(thereminGain);
      thereminGain.connect(masterGain);

      thereminGain.gain.setValueAtTime(0.2, audioContext.currentTime);
      thereminOsc.start();

      isPlaying = true;
      updateTheremin(x, y);
    }

    function updateTheremin(x, y) {
      if (!isPlaying) return;
      const freq = freqFromY(y);
      const cutoff = filterFromX(x);

      thereminOsc.frequency.setValueAtTime(freq, audioContext.currentTime);
      thereminFilter.frequency.setValueAtTime(cutoff, audioContext.currentTime);
    }

    function stopTheremin() {
      if (!isPlaying) return;
      thereminOsc.stop();
      thereminOsc.disconnect();
      thereminGain.disconnect();
      thereminFilter.disconnect();
      isPlaying = false;
    }

    // === Scroll Notes (do not interfere with theremin) ===
    function playScrollNote() {
      if (!audioContext) return;
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();

      osc.type = "triangle";
      osc.frequency.setValueAtTime(440, audioContext.currentTime);

      gain.gain.setValueAtTime(0.15, audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);

      osc.connect(gain);
      gain.connect(masterGain);

      osc.start();
      osc.stop(audioContext.currentTime + 0.3);
    }

    // ====== Feed Simulation ======
    const feed = document.getElementById("feed");

    function addPost(i) {
      const post = document.createElement("div");
      post.className = "post";
      post.textContent = "Post #" + i + " — melodic scroll...";
      feed.appendChild(post);
      playScrollNote();
    }

    function loadSkeletons(count = 3) {
      for (let i = 0; i < count; i++) {
        const sk = document.createElement("div");
        sk.className = "skeleton";
        feed.appendChild(sk);
      }
    }

    function replaceSkeletons(startIndex, count = 3) {
      const skels = feed.querySelectorAll(".skeleton");
      for (let i = 0; i < count && skels[i]; i++) {
        feed.removeChild(skels[i]);
        addPost(startIndex + i);
      }
    }

    // Initial content
    loadSkeletons(3);
    setTimeout(() => replaceSkeletons(1, 3), 1000);

    // Infinite scroll
    let postCounter = 4;
    window.addEventListener("scroll", () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 50) {
        loadSkeletons(2);
        setTimeout(() => {
          replaceSkeletons(postCounter, 2);
          postCounter += 2;
        }, 800);
      }
    });

    // ====== User Input (theremin controls) ======
    document.addEventListener("mousedown", e => {
      startTheremin(e.clientX / window.innerWidth, e.clientY / window.innerHeight);
    });
    document.addEventListener("mousemove", e => {
      if (isPlaying) {
        updateTheremin(e.clientX / window.innerWidth, e.clientY / window.innerHeight);
      }
    });
    document.addEventListener("mouseup", stopTheremin);

    // Touch support
    document.addEventListener("touchstart", e => {
      const t = e.touches[0];
      startTheremin(t.clientX / window.innerWidth, t.clientY / window.innerHeight);
    });
    document.addEventListener("touchmove", e => {
      const t = e.touches[0];
      updateTheremin(t.clientX / window.innerWidth, t.clientY / window.innerHeight);
    });
    document.addEventListener("touchend", stopTheremin);

    // Unlock AudioContext on first interaction
    window.addEventListener("click", () => {
      initAudio();
    }, { once: true });
  </script>
</body>
</html>
