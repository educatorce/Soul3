<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Melofeed</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Billabong&display=swap');
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;margin:0;background:#121212;color:#eee;user-select:none;}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:#1e1e1e;border-bottom:1px solid #333;position:sticky;top:0;z-index:1000;}
header h1{font-family:'Billabong',cursive;font-size:28px;margin:0;color:#fff;}
.menu-container{position:relative;}
.menu-icon{cursor:pointer;font-size:22px;color:#fff;}
.dropdown{display:none;position:absolute;top:40px;right:0;background:#1e1e1e;border:1px solid #333;border-radius:6px;padding:10px;z-index:1001;}
.dropdown select, .dropdown input{width:150px;margin-bottom:8px;padding:5px;background:#222;color:#eee;border:1px solid #555;border-radius:4px;cursor:pointer;}
.feed{max-width:600px;margin:20px auto;padding:0;}
.post{background:#1e1e1e;border-radius:8px;padding:15px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,0.5);border:1px solid #333;user-select:none;}
.post-header{display:flex;align-items:center;margin-bottom:10px;}
.avatar{width:40px;height:40px;border-radius:50%;background:#3a3a3a;color:#fff;display:flex;align-items:center;justify-content:center;margin-right:10px;}
.actions{display:flex;justify-content:space-around;margin-top:10px;}
.actions button{background:none;border:none;cursor:pointer;color:#eee;font-size:18px;}
.actions button:hover{color:#ff4081;}
.actions button.liked{color:#ed4956;}
.video-volume{width:100%;margin-top:5px;}
img, video{user-select:none;}
</style>
</head>
<body>

<header>
<h1>Melofeed</h1>
<div class="menu-container">
<span class="menu-icon">☰</span>
<div class="dropdown">
<select id="instrumentSelect">
  <option value="Synth">Synth</option>
  <option value="AMSynth">AMSynth</option>
  <option value="FMSynth">FMSynth</option>
  <option value="DuoSynth">DuoSynth</option>
</select>
<select id="effectSelect">
  <option value="none">No Effect</option>
  <option value="reverb">Reverb</option>
  <option value="chorus">Chorus</option>
  <option value="distortion">Distortion</option>
  <option value="tremolo">Tremolo</option>
  <option value="vibrato">Vibrato</option>
  <option value="delay">Delay</option>
</select>
<select id="scaleSelect">
  <option value="major">Major</option>
  <option value="minor">Minor</option>
  <option value="dorian">Dorian</option>
  <option value="phrygian">Phrygian</option>
  <option value="lydian">Lydian</option>
  <option value="mixolydian">Mixolydian</option>
  <option value="locrian">Locrian</option>
  <option value="harmonicMinor">Harmonic Minor</option>
  <option value="pentatonicMajor">Pentatonic Major</option>
  <option value="pentatonicMinor">Pentatonic Minor</option>
</select>
<select id="tonalitySelect">
  <option value="C">C</option><option value="C#">C#</option><option value="D">D</option>
  <option value="D#">D#</option><option value="E">E</option><option value="F">F</option>
  <option value="F#">F#</option><option value="G">G</option><option value="G#">G#</option>
  <option value="A">A</option><option value="A#">A#</option><option value="B">B</option>
</select>
<select id="arpeggioType">
  <option value="up">Ascendente</option>
  <option value="down">Descendente</option>
  <option value="random">Random</option>
</select>
<input type="number" id="arpeggioBPM" value="120" min="20" max="300" step="1" placeholder="BPM">
</div>
</div>
</header>

<main class="feed" id="feed">
<div id="posts-container"></div>
<div id="sentinel"></div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
<script src="media-list.js"></script>
<script>
let postId=0,isLoading=false;
let synth,effectNode,lowPass=new Tone.Filter(20000,"lowpass").toDestination();
let currentScale="major",currentTonality="C";
let activeTouches={};
let arpeggioInterval=null,arpeggioNotes=[],arpeggioIndex=0;
let arpeggioActive=false;

// --- Synth ---
function createSynth(type="Synth"){if(synth)synth.dispose(); synth=new Tone.PolySynth(Tone[type]).connect(lowPass);}
function applyEffect(type){if(effectNode){effectNode.dispose(); synth.disconnect(); synth.connect(lowPass);}
if(type!=="none"){switch(type){case "reverb": effectNode=new Tone.Reverb().toDestination(); break; case "chorus": effectNode=new Tone.Chorus().toDestination(); break; case "distortion": effectNode=new Tone.Distortion(0.4).toDestination(); break; case "tremolo": effectNode=new Tone.Tremolo().start().toDestination(); break; case "vibrato": effectNode=new Tone.Vibrato().toDestination(); break; case "delay": effectNode=new Tone.FeedbackDelay("8n",0.5).toDestination(); break;} synth.disconnect(); synth.connect(effectNode);}}
document.getElementById("instrumentSelect").addEventListener("change",e=>{createSynth(e.target.value); applyEffect(document.getElementById("effectSelect").value);});
document.getElementById("effectSelect").addEventListener("change",e=>applyEffect(e.target.value));
document.getElementById("scaleSelect").addEventListener("change",e=>currentScale=e.target.value);
document.getElementById("tonalitySelect").addEventListener("change",e=>currentTonality=e.target.value);

// --- Scale ---
const scales={ major:[0,2,4,5,7,9,11], minor:[0,2,3,5,7,8,10], dorian:[0,2,3,5,7,9,10], phrygian:[0,1,3,5,7,8,10], lydian:[0,2,4,6,7,9,11], mixolydian:[0,2,4,5,7,9,10], locrian:[0,1,3,5,6,8,10], harmonicMinor:[0,2,3,5,7,8,11], pentatonicMajor:[0,2,4,7,9], pentatonicMinor:[0,3,5,7,10] };
const tonalities=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
function getNoteFromY(y){const pos=1-(y/window.innerHeight); const scale=scales[currentScale]; const tonalityIndex=tonalities.indexOf(currentTonality); const totalNotes=scale.length*2; const noteIndex=Math.floor(pos*totalNotes); const octave=3+Math.floor(noteIndex/scale.length); const semitone=(scale[noteIndex%scale.length]+tonalityIndex)%12; return tonalities[semitone]+octave;}

// --- Play Note ---
function playNoteTouch(id,y,x){
  if(arpeggioActive) return;
  const note=getNoteFromY(y);
  if(activeTouches[id]) synth.triggerRelease(activeTouches[id].note);
  synth.triggerAttack(note);
  activeTouches[id]={note,noteX:x};
  const freq=200+(x/window.innerWidth)*8000;
  lowPass.frequency.setValueAtTime(freq,Tone.now());
}

// --- Release Note ---
function releaseNoteTouch(id){ if(activeTouches[id]){synth.triggerRelease(activeTouches[id].note); delete activeTouches[id]; stopArpeggioIfNeeded();} }

// --- Arpeggiator ---
function startArpeggio(rootNote,bpm,type){
    stopArpeggio();
    arpeggioActive=true;
    const rootIndex=tonalities.indexOf(rootNote.replace(/[0-9]/g,""));
    const rootOctave=parseInt(rootNote[rootNote.length-1]);
    const scaleIntervals=scales[currentScale];
    let noteList=[];
    for(let i=0;i<8;i++){
        const step=(i*2)%scaleIntervals.length;
        const octaveOffset=Math.floor((i*2)/scaleIntervals.length);
        const semitone=(scaleIntervals[step]+rootIndex)%12;
        const octave=rootOctave+octaveOffset;
        noteList.push(tonalities[semitone]+octave);
    }
    arpeggioNotes=noteList; arpeggioIndex=0;
    const intervalMs=60000/bpm;
    arpeggioInterval=setInterval(()=>{
        const note=arpeggioNotes[arpeggioIndex];
        synth.triggerAttackRelease(note,"8n");
        arpeggioIndex=(arpeggioIndex+1)%arpeggioNotes.length;
    },intervalMs);
}
function stopArpeggio(){ if(arpeggioInterval){clearInterval(arpeggioInterval); arpeggioInterval=null;} arpeggioActive=false;}
function stopArpeggioIfNeeded(){ if(Object.keys(activeTouches).length<2) stopArpeggio();}

// --- Touch / Mouse ---
window.addEventListener("touchstart",e=>{
    if(e.target.closest("header")) return; Tone.start();
    for(let t of e.touches) playNoteTouch(t.identifier,t.clientY,t.clientX);
    if(e.touches.length>=2){
        const note=getNoteFromY(e.touches[0].clientY);
        const bpm=parseInt(document.getElementById("arpeggioBPM").value)||120;
        const type=document.getElementById("arpeggioType").value;
        startArpeggio(note,bpm,type);
    }
});
window.addEventListener("touchmove",e=>{ for(let t of e.touches) playNoteTouch(t.identifier,t.clientY,t.clientX); });
window.addEventListener("touchend",e=>{ for(let t of e.changedTouches) releaseNoteTouch(t.identifier); });
window.addEventListener("mousedown",e=>{ if(e.target.closest("header")) return; Tone.start(); playNoteTouch("mouse",e.clientY,e.clientX); });
window.addEventListener("mousemove",e=>{ if(activeTouches["mouse"]) playNoteTouch("mouse",e.clientY,e.clientX); });
window.addEventListener("mouseup",()=>{ releaseNoteTouch("mouse"); });

// --- Post Generation ---
function renderMedia(filePath){
  if(!filePath) return "";
  const ext=filePath.split('.').pop().toLowerCase();
  if(["jpg","jpeg","png"].includes(ext)) return `<img src="${filePath}" style="width:100%; border-radius:8px;">`;
  if(ext==="mp4") return `<div><video src="${filePath}" style="width:100%; border-radius:8px;" muted preload="metadata"></video>
  <input type="range" class="video-volume" min="0" max="1" step="0.01" value="0.2"></div>`;
  return "";
}
function generatePost(){
  if(!mediaList || mediaList.length===0) return null;
  let media=null;
  let tries=0;
  while(tries<10){ media=mediaList[Math.floor(Math.random()*mediaList.length)]; if(media) break; tries++; }
  if(!media) return null;
  return {id:postId++,name:"User",text:"Random post",media:media};
}
function createPost(postData){
  if(!postData) return null;
  const div=document.createElement("div"); div.className="post";
  div.innerHTML=`<div class="post-header"><div class="avatar">${postData.name[0]}</div><div><strong>${postData.name}</strong></div></div>
  <div>${postData.text}</div>${postData.media?renderMedia(postData.media):""}<div class="actions"><button class="like-btn">❤️</button></div>`;
  const volSlider=div.querySelector(".video-volume");
  if(volSlider){ 
      const video=div.querySelector("video"); video.pause(); video.volume=volSlider.value;
      video.addEventListener("click",()=>video.paused?video.play():video.pause());
      volSlider.addEventListener("input",()=>{video.volume=volSlider.value;});
  }
  return div;
}
function loadMore(){ if(isLoading) return; isLoading=true;
  const container=document.getElementById("posts-container");
  for(let i=0;i<3;i++){ const postData=generatePost(); const post=createPost(postData); if(post) container.appendChild(post);}
  isLoading=false;
}
const sentinel=document.getElementById("sentinel");
const observer=new IntersectionObserver(entries=>{if(entries[0].isIntersecting) loadMore();},{rootMargin:"200px 0px"});
observer.observe(sentinel);

// --- Menu Toggle ---
document.querySelector(".menu-icon").addEventListener("click",()=>{const d=document.querySelector(".dropdown"); d.style.display=d.style.display==="block"?"none":"block";});

// --- Init ---
createSynth(); applyEffect("none"); loadMore();
</script>
</body>
</html>
