<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Melodic Feed Theremin</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Billabong&display=swap');
body, .feed { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif; margin:0; background:#121212; color:#e0e0e0; overflow-x:hidden; touch-action:none; }
.header { background:#1f1f1f; padding:10px; box-shadow:0 1px 3px rgba(0,0,0,0.7); position:sticky; top:0; z-index:100; display:flex; align-items:center; gap:5px; flex-wrap:wrap; }
.header h1 { font-family:'Billabong',cursive; font-size:32px; color:#e0e0e0; margin:0; flex:1; }
.menu-btn { background:none;border:none;color:#e0e0e0;font-size:22px;cursor:pointer; }
.dropdown { display:none; position:absolute; top:40px; left:0; background:#1f1f1f; padding:10px; border-radius:8px; z-index:200; max-width:180px; }
.dropdown label, .dropdown select, .dropdown input { color:#e0e0e0; margin-right:5px; font-size:14px; }
.feed { max-width:600px; margin:20px auto; padding:0; }
.post { background:#1e1e1e; border-radius:8px; padding:15px; margin-bottom:15px; box-shadow:0 0 1px rgba(0,0,0,0.5); border:1px solid #333; will-change: transform; backface-visibility:hidden; }
.post-header { display:flex; align-items:center; margin-bottom:10px; }
.avatar { width:40px; height:40px; border-radius:50%; background:#3a3a3a; color:#fff; display:flex; align-items:center; justify-content:center; margin-right:10px; }
.post-actions { display:flex; gap:10px; margin-top:10px; padding-top:10px; border-top:1px solid #444; }
.action-btn { flex:1; padding:8px; border:none; background:none; cursor:pointer; color:#b3b3b3; font-weight:bold; text-align:center; font-size:14px; }
.action-btn:hover { background:#333; border-radius:4px; }
.action-btn.liked { color:#ed4956; }
.skeleton-post { background:#1e1e1e; border-radius:8px; padding:15px; margin-bottom:15px; height:150px; animation:pulse 1.5s infinite; border:1px solid #333; }
@keyframes pulse {0%{opacity:0.6}50%{opacity:1}100%{opacity:0.6}}
#touch-visual { position:fixed; width:30px; height:30px; background:#ff5f6d; border-radius:50%; top:0; left:0; pointer-events:none; opacity:0.7; transform:translate(-50%,-50%); display:none; z-index:300; }
#note-display { position:fixed; top:10px; right:10px; color:#ff5f6d; font-size:18px; font-weight:bold; z-index:400; }
img, video { user-select:none; -webkit-user-drag:none; touch-action:none; }
</style>
</head>
<body>

<div class="header">
  <h1>üéµ MeloFeed</h1>
  <div style="position:relative;"><button class="menu-btn" id="menu-instr">üéπ</button>
    <div class="dropdown" id="instr-dropdown">
      <label>Instrument:</label>
      <select id="instrument-select">
        <option value="Synth">Synth (Sine)</option>
        <option value="AMSynth">AMSynth</option>
        <option value="FMSynth">FMSynth</option>
        <option value="MembraneSynth">MembraneSynth</option>
      </select>
    </div>
  </div>
  <div style="position:relative;"><button class="menu-btn" id="menu-effects">üéõÔ∏è</button>
    <div class="dropdown" id="effects-dropdown">
      <label><input type="checkbox" class="effect-toggle" value="Reverb"> Reverb</label><br>
      <label><input type="checkbox" class="effect-toggle" value="Chorus"> Chorus</label><br>
      <label><input type="checkbox" class="effect-toggle" value="Distortion"> Distortion</label><br>
      <label><input type="checkbox" class="effect-toggle" value="Tremolo"> Tremolo</label><br>
      <label><input type="checkbox" class="effect-toggle" value="Vibrato"> Vibrato</label><br>
      <label><input type="checkbox" class="effect-toggle" value="Delay"> Delay</label>
    </div>
  </div>
  <div style="position:relative;"><button class="menu-btn" id="menu-scale">üéº</button>
    <div class="dropdown" id="scale-dropdown">
      <label>Scale:</label>
      <select id="scale-select">
        <option>Major</option><option>Minor</option><option>Dorian</option><option>Phrygian</option>
        <option>Lydian</option><option>Mixolydian</option><option>Aeolian</option><option>Locrian</option>
        <option>Harmonic Minor</option><option>Major Pentatonic</option><option>Minor Pentatonic</option>
      </select>
    </div>
  </div>
  <div style="position:relative;"><button class="menu-btn" id="menu-tonic">üéµ</button>
    <div class="dropdown" id="tonic-dropdown">
      <select id="tonic-select">
        <option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option>
        <option>F</option><option>F#</option><option>G</option><option>G#</option>
        <option>A</option><option>A#</option><option>B</option>
      </select>
    </div>
  </div>
</div>

<div class="feed" role="feed" aria-live="polite">
  <div id="posts-container"></div>
  <div id="sentinel"></div>
</div>

<div id="touch-visual"></div>
<div id="note-display"></div>

<script src="https://cdn.jsdelivr.net/npm/tone@next/build/Tone.js"></script>
<script src="media-list.js"></script>
<script>
// Globals
let postId=0,isLoading=false,voices={},maxVoices=1;
let selectedInstrument='Synth',selectedScale='Major',selectedTonic='C';
let enabledEffects={};
const scales={
  Major:[0,2,4,5,7,9,11,12],
  Minor:[0,2,3,5,7,8,10,12],
  Dorian:[0,2,3,5,7,9,10,12],
  Phrygian:[0,1,3,5,7,8,10,12],
  Lydian:[0,2,4,6,7,9,11,12],
  Mixolydian:[0,2,4,5,7,9,10,12],
  Aeolian:[0,2,3,5,7,8,10,12],
  Locrian:[0,1,3,5,6,8,10,12],
  'Harmonic Minor':[0,2,3,5,7,8,11,12],
  'Major Pentatonic':[0,2,4,7,9,12],
  'Minor Pentatonic':[0,3,5,7,10,12]
};

// Dropdown menus
const menuMap={'menu-instr':'instr-dropdown','menu-effects':'effects-dropdown','menu-scale':'scale-dropdown','menu-tonic':'tonic-dropdown'};
for(const btnId in menuMap){
  const btn=document.getElementById(btnId);
  const dd=document.getElementById(menuMap[btnId]);
  btn.addEventListener('click',()=>{
    for(const otherId in menuMap) if(otherId!==btnId) document.getElementById(menuMap[otherId]).style.display='none';
    dd.style.display=dd.style.display==='none'?'block':'none';
  });
}
document.getElementById('instrument-select').addEventListener('change',e=>selectedInstrument=e.target.value);
document.getElementById('scale-select').addEventListener('change',e=>selectedScale=e.target.value);
document.getElementById('tonic-select').addEventListener('change',e=>selectedTonic=e.target.value);
document.querySelectorAll('.effect-toggle').forEach(cb=>{
  cb.addEventListener('change', e=>{
    if(e.target.checked){
      document.querySelectorAll('.effect-toggle').forEach(other=>{if(other!==e.target) other.checked=false;});
      enabledEffects={}; enabledEffects[e.target.value]=true;
    } else { enabledEffects[e.target.value]=false; }
  });
});

// Touch visuals
const touchVisual=document.getElementById('touch-visual');
const noteDisplay=document.getElementById('note-display');
function showTouch(x,y){touchVisual.style.left=x+'px'; touchVisual.style.top=y+'px'; touchVisual.style.display='block';}
function hideTouch(){touchVisual.style.display='none';}

// Map y to note 2 octaves
function yToNote(y){
  const norm=1-Math.min(Math.max(y/window.innerHeight,0),1);
  const scaleIntervals=scales[selectedScale];
  const totalSteps=scaleIntervals.length*2;
  const stepIndex=Math.floor(norm*totalSteps);
  const octave=3+Math.floor(stepIndex/scaleIntervals.length);
  const noteIndex=stepIndex%scaleIntervals.length;
  const noteName = Tone.Frequency(selectedTonic + '3').transpose(scaleIntervals[noteIndex]).toNote();
  return noteName.replace(/\d+$/, octave);
}
function xToFilter(x){return Math.max(300,Math.min(5000,(x/window.innerWidth)*5000));}

// Voice controls
async function startVoice(id,x,y){
  await Tone.start();
  if(Object.keys(voices).length>=maxVoices) return;
  const note=yToNote(y);
  const filter=new Tone.Filter(xToFilter(x),'lowpass').toDestination();
  const synthClass={Synth:Tone.Synth,AMSynth:Tone.AMSynth,FMSynth:Tone.FMSynth,MembraneSynth:Tone.MembraneSynth}[selectedInstrument]||Tone.Synth;
  const synth=new synthClass({oscillator:{type:'sine'}}).connect(filter);
  if(enabledEffects.Reverb) synth.connect(new Tone.Reverb().toDestination());
  else if(enabledEffects.Chorus) synth.connect(new Tone.Chorus().toDestination());
  else if(enabledEffects.Distortion) synth.connect(new Tone.Distortion().toDestination());
  else if(enabledEffects.Tremolo) synth.connect(new Tone.Tremolo().toDestination().start());
  else if(enabledEffects.Vibrato) synth.connect(new Tone.Vibrato().toDestination().start());
  else if(enabledEffects.Delay) synth.connect(new Tone.FeedbackDelay('8n').toDestination());
  synth.triggerAttack(note);
  voices[id]={synth,filter};
  noteDisplay.textContent=note;
}
function updateVoice(id,x,y){
  if(!voices[id]) return;
  const note=yToNote(y);
  const filterFreq=xToFilter(x);
  voices[id].filter.frequency.value=filterFreq;
  voices[id].synth.setNote(note);
  noteDisplay.textContent=note;
}
function stopVoice(id){
  if(!voices[id]) return;
  voices[id].synth.triggerRelease();
  delete voices[id];
  noteDisplay.textContent='';
}

// Post rendering
function generatePost(){
  const names=['Emma','Liam','Olivia','Noah','Ava'];
  const texts=['Having a great day! üòä','Check out this amazing view! üåÖ','Coffee time ‚òï','Working on something exciting! üöÄ','Weekend vibes üéâ'];
  let media=null;
  if(typeof mediaList!=='undefined' && mediaList.length>0 && Math.random()>0.5) media=mediaList[Math.floor(Math.random()*mediaList.length)];
  return {id:postId++,name:names[Math.floor(Math.random()*names.length)],text:texts[Math.floor(Math.random()*texts.length)],time:'2 hours ago',media};
}
function renderMedia(filePath){const ext=filePath.split('.').pop().toLowerCase(); if(['jpg','jpeg','png'].includes(ext)) return `<div style="margin-top:10px;"><img src="${filePath}" alt="Post media" style="width:100%;border-radius:8px;"></div>`; else if(ext==='mp4') return `<div style="margin-top:10px;"><video src="${filePath}" controls style="width:100%;border-radius:8px;"></video></div>`; else return '';}
function createPost(postData){
  const postDiv=document.createElement('div'); postDiv.className='post'; postDiv.dataset.postId=postData.id;
  postDiv.innerHTML=`<div class="post-header"><div class="avatar">${postData.name[0]}</div><div><div><strong>${postData.name}</strong></div><div style="font-size:12px;color:#999;">${postData.time}</div></div></div><div>${postData.text}</div>${postData.media?renderMedia(postData.media):''}<div class="post-actions"><button class="action-btn like-btn" role="button" tabindex="0" aria-pressed="false">üëç Like</button><button class="action-btn" role="button" tabindex="0">üí¨ Comment</button><button class="action-btn" role="button" tabindex="0">üì§ Share</button></div>`;
  const likeBtn=postDiv.querySelector('.like-btn'); likeBtn.addEventListener('click',()=>{ likeBtn.classList.toggle('liked'); const isLiked=likeBtn.classList.contains('liked'); likeBtn.setAttribute('aria-pressed',isLiked); likeBtn.textContent=isLiked?'‚ù§Ô∏è Liked':'üëç Like'; });
  return postDiv;
}
function loadMore(){if(isLoading)return; isLoading=true; const container=document.getElementById('posts-container'); const skeletons=[]; for(let i=0;i<5;i++){const skeleton=document.createElement('div'); skeleton.className='skeleton-post'; container.appendChild(skeleton); skeletons.push(skeleton);} setTimeout(()=>{skeletons.forEach(skeleton=>{const postData=generatePost(); const postElement=createPost(postData); skeleton.replaceWith(postElement);}); isLoading=false;},600);}
window.addEventListener('DOMContentLoaded',()=>{const sentinel=document.getElementById('sentinel'); const observer=new IntersectionObserver(entries=>{if(entries[0].isIntersecting) loadMore();},{rootMargin:'200px 0px'}); observer.observe(sentinel); loadMore(); setTimeout(()=>loadMore(),100);});

// Theremin pointer events
let lastUpdate=0;
document.addEventListener('pointerdown',async e=>{
  if(e.target.closest('.header,.post img,.post video')) return;
  e.preventDefault(); await Tone.start();
  startVoice('main',e.clientX,e.clientY); showTouch(e.clientX,e.clientY);
});
document.addEventListener('pointermove',e=>{
  if(!voices['main']) return;
  const now=performance.now(); if(now-lastUpdate<16) return; lastUpdate=now;
  if(e.target.closest('.header')) return;
  e.preventDefault(); updateVoice('main',e.clientX,e.clientY); showTouch(e.clientX,e.clientY);
});
document.addEventListener('pointerup',e=>{ stopVoice('main'); hideTouch(); });
document.addEventListener('pointercancel',e=>{ stopVoice('main'); hideTouch(); });
window.addEventListener('blur',()=>{ stopVoice('main'); hideTouch(); });

</script>
</body>
</html>
