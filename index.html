<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Melofeed</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Billabong&display=swap');
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: #121212;
      color: #fff;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #1e1e1e;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .logo {
      font-family: 'Billabong', cursive;
      font-size: 2rem;
    }
    .menu {
      display: flex;
      gap: 1rem;
    }
    .menu select {
      background: #2c2c2c;
      color: #fff;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
    }
    main {
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem;
    }
    .post {
      background: #1e1e1e;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      padding: 1rem;
    }
    .post img, .post video {
      width: 100%;
      border-radius: 10px;
      margin-top: 0.5rem;
    }
    .actions {
      display: flex;
      justify-content: space-around;
      margin-top: 0.5rem;
    }
    .actions button {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">Melofeed</div>
    <div class="menu">
      <select id="instrument">
        <option value="Synth">Synth</option>
        <option value="AMSynth">AMSynth</option>
        <option value="FMSynth">FMSynth</option>
        <option value="MonoSynth">MonoSynth</option>
      </select>
      <select id="scale">
        <option value="major">Major</option>
        <option value="minor">Minor</option>
        <option value="dorian">Dorian</option>
        <option value="phrygian">Phrygian</option>
        <option value="lydian">Lydian</option>
        <option value="mixolydian">Mixolydian</option>
        <option value="aeolian">Aeolian</option>
        <option value="locrian">Locrian</option>
        <option value="harmonicMinor">Harmonic Minor</option>
        <option value="melodicMinor">Melodic Minor</option>
        <option value="pentatonicMajor">Pentatonic Major</option>
        <option value="pentatonicMinor">Pentatonic Minor</option>
      </select>
      <select id="tonic">
        <option value="C">C</option>
        <option value="C#">C#</option>
        <option value="D">D</option>
        <option value="D#">D#</option>
        <option value="E">E</option>
        <option value="F">F</option>
        <option value="F#">F#</option>
        <option value="G">G</option>
        <option value="G#">G#</option>
        <option value="A">A</option>
        <option value="A#">A#</option>
        <option value="B">B</option>
      </select>
      <select id="effect">
        <option value="none">No Effect</option>
        <option value="reverb">Reverb</option>
        <option value="chorus">Chorus</option>
        <option value="distortion">Distortion</option>
        <option value="tremolo">Tremolo</option>
        <option value="vibrato">Vibrato</option>
        <option value="delay">Delay</option>
      </select>
    </div>
  </header>
  <main id="feed"></main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <script>
    // Load posts from media-list.json (RESTORED)
    async function loadPosts() {
      try {
        const response = await fetch("media-list.json");
        const posts = await response.json();
        const feed = document.getElementById("feed");
        feed.innerHTML = "";

        posts.forEach(post => {
          const div = document.createElement("div");
          div.className = "post";
          div.innerHTML = `
            <h3>${post.title}</h3>
            ${post.type === "image" ? `<img src="${post.src}" alt="">` : ""}
            ${post.type === "video" ? `<video controls><source src="${post.src}" type="video/mp4"></video>` : ""}
            <div class="actions">
              <button>‚ù§Ô∏è</button>
              <button>üí¨</button>
              <button>üîó</button>
            </div>
          `;
          feed.appendChild(div);
        });
      } catch (err) {
        console.error("Error loading posts:", err);
      }
    }
    loadPosts();

    // Tone.js musical interaction
    let synth, filter, effect, active = false;

    const instruments = {
      Synth: () => new Tone.Synth(),
      AMSynth: () => new Tone.AMSynth(),
      FMSynth: () => new Tone.FMSynth(),
      MonoSynth: () => new Tone.MonoSynth()
    };

    function updateSynth() {
      if (synth) synth.dispose();
      synth = instruments[document.getElementById("instrument").value]();
      filter = new Tone.Filter(800, "lowpass").toDestination();
      synth.connect(filter);
    }
    updateSynth();

    document.getElementById("instrument").addEventListener("change", updateSynth);
    document.getElementById("effect").addEventListener("change", (e) => {
      if (effect) effect.dispose();
      effect = null;
      let choice = e.target.value;
      if (choice !== "none") {
        switch (choice) {
          case "reverb": effect = new Tone.Reverb().toDestination(); break;
          case "chorus": effect = new Tone.Chorus().toDestination(); break;
          case "distortion": effect = new Tone.Distortion().toDestination(); break;
          case "tremolo": effect = new Tone.Tremolo().start().toDestination(); break;
          case "vibrato": effect = new Tone.Vibrato().toDestination(); break;
          case "delay": effect = new Tone.FeedbackDelay("8n", 0.5).toDestination(); break;
        }
        synth.disconnect();
        synth.connect(effect);
        effect.connect(filter);
      } else {
        synth.disconnect();
        synth.connect(filter);
      }
    });

    const scales = {
      major: [0, 2, 4, 5, 7, 9, 11],
      minor: [0, 2, 3, 5, 7, 8, 10],
      dorian: [0, 2, 3, 5, 7, 9, 10],
      phrygian: [0, 1, 3, 5, 7, 8, 10],
      lydian: [0, 2, 4, 6, 7, 9, 11],
      mixolydian: [0, 2, 4, 5, 7, 9, 10],
      aeolian: [0, 2, 3, 5, 7, 8, 10],
      locrian: [0, 1, 3, 5, 6, 8, 10],
      harmonicMinor: [0, 2, 3, 5, 7, 8, 11],
      melodicMinor: [0, 2, 3, 5, 7, 9, 11],
      pentatonicMajor: [0, 2, 4, 7, 9],
      pentatonicMinor: [0, 3, 5, 7, 10]
    };

    const notes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    function getNoteFromPosition(y) {
      const scale = document.getElementById("scale").value;
      const tonic = document.getElementById("tonic").value;
      const octaveRange = 2; // 2 octaves
      const noteCount = scales[scale].length * octaveRange;
      const idx = Math.floor((1 - y / window.innerHeight) * noteCount);
      const tonicIndex = notes.indexOf(tonic);
      const octave = 3 + Math.floor(idx / scales[scale].length);
      const pitch = scales[scale][idx % scales[scale].length];
      return notes[(tonicIndex + pitch) % 12] + octave;
    }

    function handleStart(e) {
      e.preventDefault();
      Tone.start();
      active = true;
      handleMove(e);
    }

    function handleMove(e) {
      if (!active) return;
      const touch = e.touches ? e.touches[0] : e;
      const note = getNoteFromPosition(touch.clientY);
      const freq = Tone.Frequency(note).toFrequency();
      if (!synth) return;
      synth.triggerAttack(freq);
      let cutoff = (touch.clientX / window.innerWidth) * 10000;
      filter.frequency.setValueAtTime(cutoff, Tone.now());
    }

    function handleEnd() {
      active = false;
      if (synth) synth.triggerRelease();
    }

    document.addEventListener("touchstart", handleStart);
    document.addEventListener("touchmove", handleMove);
    document.addEventListener("touchend", handleEnd);

    document.addEventListener("mousedown", handleStart);
    document.addEventListener("mousemove", handleMove);
    document.addEventListener("mouseup", handleEnd);
  </script>
</body>
</html>
