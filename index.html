<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Melodic Feed</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Billabong&display=swap');
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin:0; background:#121212; color:#e0e0e0; }
.header { background:#1f1f1f; padding:15px 20px; box-shadow:0 1px 3px rgba(0,0,0,0.7); position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:center; border-bottom:1px solid #333; }
.header h1 { font-family:'Billabong', cursive; font-size:32px; color:#e0e0e0; }
.feed { max-width:600px; margin:20px auto; padding:0; }
.post { background:#1e1e1e; border-radius:8px; padding:15px; margin-bottom:15px; box-shadow:0 0 1px rgba(0,0,0,0.5); border:1px solid #333; }
.post-header { display:flex; align-items:center; margin-bottom:10px; }
.avatar { width:40px; height:40px; border-radius:50%; background:#3a3a3a; color:#fff; display:flex; align-items:center; justify-content:center; margin-right:10px; }
.post-actions { display:flex; gap:10px; margin-top:10px; padding-top:10px; border-top:1px solid #444; }
.action-btn { flex:1; padding:8px; border:none; background:none; cursor:pointer; color:#b3b3b3; font-weight:bold; text-align:center; }
.action-btn:hover { background:#333; border-radius:4px; }
.action-btn.liked { color:#ed4956; }
.skeleton-post { background:#1e1e1e; border-radius:8px; padding:15px; margin-bottom:15px; height:150px; animation:pulse 1.5s infinite; border:1px solid #333; }
@keyframes pulse { 0%{opacity:0.6} 50%{opacity:1} 100%{opacity:0.6} }
/* Instrument menu styling */
.instrument-menu { position:fixed; bottom:20px; left:20px; background:#1f1f1f; padding:10px 15px; border-radius:10px; color:#e0e0e0; z-index:200; }
.instrument-menu select { margin-left:10px; padding:4px; }
</style>
</head>
<body>
<div class="header"><h1>üéµ MeloFeed</h1></div>

<div class="feed" role="feed" aria-live="polite">
    <div id="posts-container"></div>
    <div id="sentinel"></div>
</div>

<div class="instrument-menu">
    <label for="instrument-select">Instrument:</label>
    <select id="instrument-select">
        <option value="Synth">Synth (Sine)</option>
        <option value="AMSynth">AMSynth</option>
        <option value="FMSynth">FMSynth</option>
        <option value="MembraneSynth">MembraneSynth</option>
    </select>
</div>

<script src="https://cdn.jsdelivr.net/npm/tone@next/build/Tone.js"></script>
<script src="media-list.js"></script>
<script>
let postId = 0, isLoading = false, currentWaveform = 'sine', selectedInstrument = 'Synth';
const voices = {}, maxVoices = 2;
const basePitches = ['C4','D#4','F4','G4','A#4','C5','D#5','F5','G5','A#5'];

const instrumentSelect = document.getElementById('instrument-select');
instrumentSelect.addEventListener('change', e => { selectedInstrument = e.target.value; });

async function initAudio(){ await Tone.start(); }

function yToNote(y){ const norm = 1 - Math.min(Math.max(y/window.innerHeight,0),1); return basePitches[Math.floor(norm*(basePitches.length-1))]; }
function xToFilter(x){ const norm = Math.min(Math.max(x/window.innerWidth,0),1); return 200 + norm*(8000-200); }

function startVoice(id,x,y){
    if(Object.keys(voices).length >= maxVoices) return;
    if(voices[id]) return; // only play once per press
    let synth;
    switch(selectedInstrument){
        case 'AMSynth': synth = new Tone.AMSynth({envelope:{attack:0.01, decay:0.1, sustain:0.5, release:0.2}}).toDestination(); break;
        case 'FMSynth': synth = new Tone.FMSynth({envelope:{attack:0.01, decay:0.1, sustain:0.5, release:0.2}}).toDestination(); break;
        case 'MembraneSynth': synth = new Tone.MembraneSynth({envelope:{attack:0.01, decay:0.1, sustain:0.5, release:0.2}}).toDestination(); break;
        default: synth = new Tone.Synth({oscillator:{type:currentWaveform}, envelope:{attack:0.01, decay:0.1, sustain:0.5, release:0.2}}).toDestination();
    }
    const filter = new Tone.Filter(xToFilter(x),"lowpass").toDestination();
    synth.connect(filter);
    synth.triggerAttackRelease(yToNote(y), "8n"); // play only once
    voices[id] = { synth, filter };
}

function stopVoice(id){ delete voices[id]; } // nothing to release, note already finished

// pointer + touch events
document.addEventListener('pointerdown', e => { initAudio(); startVoice(e.pointerId,e.clientX,e.clientY); });
document.addEventListener('touchstart', e => { initAudio(); for(let t of e.changedTouches) startVoice(t.identifier,t.clientX,t.clientY); e.preventDefault(); }, {passive:false});

// posts & media
function renderMedia(path){ const ext=path.split('.').pop().toLowerCase();
if(['jpg','jpeg','png'].includes(ext)) return `<div style="margin-top:10px;"><img src="${path}" alt="Post media" style="width:100%;border-radius:8px;"></div>`;
if(ext==='mp4') return `<div style="margin-top:10px;"><video src="${path}" controls style="width:100%;border-radius:8px;"></video></div>`; return ''; }

function generatePost(){ const names=['Emma','Liam','Olivia','Noah','Ava']; const texts=['Having a great day! üòä','Check out this amazing view! üåÖ','Coffee time ‚òï','Working on something exciting! üöÄ','Weekend vibes üéâ'];
let media=null; if(typeof mediaList!=='undefined' && mediaList.length>0 && Math.random()>0.5) media=mediaList[Math.floor(Math.random()*mediaList.length)];
return {id:postId++, name:names[Math.floor(Math.random()*names.length)], text:texts[Math.floor(Math.random()*texts.length)], time:'2 hours ago', media}; }

function createPost(postData){
    const postDiv=document.createElement('div'); postDiv.className='post'; postDiv.dataset.postId=postData.id;
    postDiv.innerHTML=`<div class="post-header"><div class="avatar">${postData.name[0]}</div><div><div><strong>${postData.name}</strong></div><div style="font-size:12px;color:#999;">${postData.time}</div></div></div>
    <div>${postData.text}</div>
    ${postData.media?renderMedia(postData.media):''}
    <div class="post-actions">
        <button class="action-btn like-btn">üëç Like</button>
        <button class="action-btn comment-btn">üí¨ Comment</button>
        <button class="action-btn share-btn">üì§ Share</button>
    </div>`;
    postDiv.querySelector('.like-btn').addEventListener('click',()=>{currentWaveform='sine'; postDiv.querySelector('.like-btn').classList.toggle('liked');});
    postDiv.querySelector('.comment-btn').addEventListener('click',()=>{currentWaveform='square';});
    postDiv.querySelector('.share-btn').addEventListener('click',()=>{currentWaveform='triangle';});
    return postDiv;
}

function loadMore(){ if(isLoading) return; isLoading=true;
    const container=document.getElementById('posts-container'); const feed=document.querySelector('.feed'); feed.setAttribute('aria-busy','true'); const skeletons=[];
    for(let i=0;i<5;i++){ const skeleton=document.createElement('div'); skeleton.className='skeleton-post'; container.appendChild(skeleton); skeletons.push(skeleton);}
    setTimeout(()=>{ skeletons.forEach(s=>{ const post=createPost(generatePost()); s.replaceWith(post); }); feed.setAttribute('aria-busy','false'); isLoading=false; },300);
}

window.addEventListener('DOMContentLoaded',()=>{
    const sentinel=document.getElementById('sentinel');
    const observer=new IntersectionObserver(entries=>{if(entries[0].isIntersecting) loadMore();},{rootMargin:'200px 0px'});
    observer.observe(sentinel);
    loadMore(); setTimeout(()=>loadMore(),100);
});
</script>
</body>
</html>
